<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚å…‰è¡Œè€…ï¼šç§¦æ¼¢é¢¨é›² (åƒç´ æœ€çµ‚ç‰ˆ)</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <!-- å¼•å…¥ Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- å¼•å…¥åƒç´ å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'DotGothic16', 'Noto Serif TC', sans-serif;
            background-color: #121212;
            background-image: 
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        /* æ²è»¸å®¹å™¨é¢¨æ ¼ */
        .scroll-container {
            background-color: #2a2a2a;
            border: 4px solid #8b7355;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        /* åƒç´ æŒ‰éˆ• */
        .pixel-btn {
            position: relative;
            background-color: #3d3d3d;
            border: 4px solid;
            border-color: #6b6b6b #2a2a2a #2a2a2a #6b6b6b;
            transition: transform 0.1s;
            cursor: pointer;
        }
        .pixel-btn:active:not(:disabled) {
            transform: translate(2px, 2px);
            border-color: #2a2a2a #6b6b6b #6b6b6b #2a2a2a;
        }
        .pixel-btn:hover:not(:disabled) {
            background-color: #4d4d4d;
        }
        .pixel-btn.selected {
            background-color: #4a4238;
            border-color: #d4af37;
        }

        /* æµ®å‹•æ•¸å€¼å‹•ç•« */
        .stat-float {
            position: absolute;
            animation: floatUp 2.5s ease-out forwards;
            font-weight: 900;
            pointer-events: none;
            z-index: 100;
            text-shadow: 2px 2px 0px #000;
            font-size: 1.2rem;
        }
        @keyframes floatUp {
            0% { opacity: 0; transform: translateY(10px); }
            15% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-60px); }
        }
        
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #8b7355; border: 1px solid #1a1a1a; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- åƒç´ é¢¨æ ¼ SVG åœ–ç‰‡åº« (å…§å»º Base64 æ›¿ä»£æ–¹æ¡ˆ) ---
        // é€™äº›æ˜¯ä½¿ç”¨ SVG ç¹ªè£½çš„ç°¡å–®åƒç´ è—è¡“ï¼Œç¢ºä¿ç„¡é ˆå¤–éƒ¨é€£çµå³å¯é¡¯ç¤º
        const SceneImages = {
            Classroom: () => (
                <svg viewBox="0 0 64 64" className="w-full h-full bg-blue-200">
                    <rect x="8" y="10" width="48" height="24" fill="#2d3748" stroke="#1a202c" strokeWidth="2"/>
                    <text x="12" y="26" fontSize="6" fill="white" fontFamily="monospace">HISTORY</text>
                    <rect x="16" y="40" width="32" height="16" fill="#d69e2e" stroke="#744210" strokeWidth="2"/>
                    <rect x="24" y="36" width="16" height="8" fill="white" stroke="#a0aec0"/>
                </svg>
            ),
            QinPalace: () => (
                <svg viewBox="0 0 64 64" className="w-full h-full bg-gray-800">
                    <path d="M8 56 L56 56 L56 32 L32 16 L8 32 Z" fill="#742a2a" stroke="#000" strokeWidth="2"/>
                    <rect x="24" y="40" width="16" height="16" fill="#1a202c"/>
                    <path d="M32 16 L32 8" stroke="#ecc94b" strokeWidth="2"/>
                    <circle cx="32" cy="6" r="2" fill="#ecc94b"/>
                    <rect x="12" y="32" width="8" height="8" fill="#4a5568"/>
                    <rect x="44" y="32" width="8" height="8" fill="#4a5568"/>
                </svg>
            ),
            GreatWall: () => (
                <svg viewBox="0 0 64 64" className="w-full h-full bg-sky-300">
                    <path d="M0 40 L20 30 L40 35 L64 25 L64 64 L0 64 Z" fill="#708090"/>
                    <path d="M0 35 L10 35 L10 30 L15 30 L15 35 L25 35 L25 30 L30 30 L30 35 L64 35 L64 45 L0 45 Z" fill="#cbd5e0" stroke="#4a5568" strokeWidth="1"/>
                    <rect x="15" y="22" width="12" height="13" fill="#cbd5e0" stroke="#4a5568" strokeWidth="1"/>
                    <rect x="18" y="25" width="6" height="6" fill="#2d3748"/>
                </svg>
            ),
            War: () => (
                <svg viewBox="0 0 64 64" className="w-full h-full bg-orange-200">
                    <rect x="0" y="40" width="64" height="24" fill="#744210"/>
                    <path d="M10 40 L20 20 L30 40" fill="#2d3748" stroke="black"/>
                    <path d="M35 40 L45 25 L55 40" fill="#2d3748" stroke="black"/>
                    <line x1="45" y1="25" x2="45" y2="10" stroke="black" strokeWidth="1"/>
                    <rect x="45" y="10" width="10" height="6" fill="#e53e3e"/>
                    <circle cx="15" cy="50" r="4" fill="#a0aec0"/>
                    <path d="M50 50 L60 40" stroke="#718096" strokeWidth="2"/>
                </svg>
            ),
            Treasury: () => (
                <svg viewBox="0 0 64 64" className="w-full h-full bg-gray-900">
                    <rect x="10" y="20" width="44" height="30" fill="#b7791f" rx="2"/>
                    <path d="M10 20 L32 10 L54 20" fill="#d69e2e"/>
                    <circle cx="32" cy="35" r="8" fill="#ecc94b" stroke="#744210" strokeWidth="2"/>
                    <rect x="29" y="32" width="6" height="6" fill="#744210"/>
                    <circle cx="20" cy="45" r="4" fill="#ecc94b"/>
                    <circle cx="44" cy="45" r="4" fill="#ecc94b"/>
                </svg>
            ),
            Farm: () => (
                <svg viewBox="0 0 64 64" className="w-full h-full bg-blue-100">
                    <circle cx="50" cy="10" r="5" fill="#ecc94b"/>
                    <rect x="0" y="40" width="64" height="24" fill="#48bb78"/>
                    <path d="M10 40 L15 30 L20 40 M30 40 L35 30 L40 40" stroke="#f6e05e" strokeWidth="2" fill="none"/>
                    <rect x="45" y="35" width="15" height="15" fill="#9c4221"/>
                    <path d="M42 35 L52 25 L63 35" fill="#742a2a"/>
                </svg>
            ),
            Study: () => (
                <svg viewBox="0 0 64 64" className="w-full h-full bg-amber-50">
                    <rect x="10" y="10" width="44" height="44" fill="#f6e05e" stroke="#744210" strokeWidth="2"/>
                    <line x1="15" y1="10" x2="15" y2="54" stroke="#744210" strokeWidth="1"/>
                    <line x1="20" y1="10" x2="20" y2="54" stroke="#744210" strokeWidth="1"/>
                    <line x1="44" y1="10" x2="44" y2="54" stroke="#744210" strokeWidth="1"/>
                    <rect x="32" y="20" width="12" height="24" fill="white" stroke="black"/>
                    <path d="M35 25 L41 25 M35 30 L41 30" stroke="black" strokeWidth="1"/>
                </svg>
            ),
            Fire: () => (
                <svg viewBox="0 0 64 64" className="w-full h-full bg-black">
                    <path d="M10 64 L25 20 L40 64" fill="#c53030"/>
                    <path d="M20 64 L35 30 L50 64" fill="#dd6b20"/>
                    <path d="M30 64 L40 45 L45 64" fill="#ecc94b"/>
                </svg>
            ),
            Desert: () => (
                <svg viewBox="0 0 64 64" className="w-full h-full bg-orange-100">
                    <path d="M0 40 Q32 20 64 40 L64 64 L0 64" fill="#d69e2e"/>
                    <circle cx="10" cy="10" r="6" fill="#c05621"/>
                    <path d="M40 30 L45 25 L50 30" stroke="black" strokeWidth="1" fill="none"/>
                </svg>
            ),
            Prison: () => (
                <svg viewBox="0 0 64 64" className="w-full h-full bg-gray-700">
                    <rect x="10" y="10" width="44" height="44" fill="none" stroke="#cbd5e0" strokeWidth="4"/>
                    <line x1="21" y1="10" x2="21" y2="54" stroke="#cbd5e0" strokeWidth="2"/>
                    <line x1="32" y1="10" x2="32" y2="54" stroke="#cbd5e0" strokeWidth="2"/>
                    <line x1="43" y1="10" x2="43" y2="54" stroke="#cbd5e0" strokeWidth="2"/>
                </svg>
            ),
            History: () => (
                <svg viewBox="0 0 64 64" className="w-full h-full bg-indigo-900">
                    <path d="M20 10 L44 10 L44 54 L20 54 Z" fill="#f7fafc"/>
                    <path d="M20 10 L15 15 L15 59 L20 54" fill="#cbd5e0"/>
                    <text x="25" y="35" fontSize="20">å²</text>
                </svg>
            )
        };

        // --- UI åœ–ç¤º ---
        const Icons = {
            Heart: () => <span className="text-xl">â¤</span>,
            Brain: () => <span className="text-xl">ğŸ§ </span>,
            Coin: () => <span className="text-xl">ğŸ’°</span>,
            Star: () => <span className="text-xl">ğŸ‘‘</span>,
            ArrowRight: () => <span className="text-lg">â–¶</span>,
            Refresh: () => <span className="text-lg">â†»</span>
        };

        // --- æ­·å²åŠ‡æœ¬è³‡æ–™ (20å€‹é—œå¡ + è±å¯Œéš¨æ©Ÿäº‹ä»¶) ---
        const storyNodes = {
            "intro": {
                id: "intro",
                title: "åºç« ï¼šæ­·å²çš„å¬å–š",
                text: "è¥¿å…ƒ2024å¹´ã€‚æ­·å²èª²ä¸Šï¼Œè€å¸«è¬›è¿°è‘—ï¼šã€Œç§¦çš‡æ¼¢æ­¦ï¼Œç•¥è¼¸æ–‡é‡‡...ã€ä½ çš„æ€ç·’é£„å‘äº†å…©åƒå¹´å‰çš„æ™‚ç©ºæ¼©æ¸¦ã€‚",
                image: "Classroom",
                options: [
                    { text: "èªçœŸè½èª²", nextId: "qin_war", effect: { knowledge: 10 }, feedback: "çŸ¥è­˜å°±æ˜¯åŠ›é‡ï¼Œä½ è¨˜ä½äº†ç§¦æ¼¢çš„é—œéµã€‚", historyNote: "å­¸ç¿’æ­·å²èƒ½å¹«åŠ©æˆ‘å€‘ç†è§£éå»ï¼Œé è¦‹æœªä¾†ã€‚" },
                    { text: "ç¡è¦ºå„²å­˜é«”åŠ›", nextId: "qin_war", effect: { health: 10 }, feedback: "ç²¾ç¥é£½æ»¿åœ°ç©¿è¶Šäº†ï¼", historyNote: "ç©¿è¶Šæ•…äº‹å¾€å¾€å§‹æ–¼ä¸€å ´æ„å¤–çš„ç¡çœ ã€‚" },
                    { text: "å·çœ‹èª²å¤–æ›¸", nextId: "qin_war", effect: { wealth: 5, reputation: -5 }, feedback: "ä½ ç²å¾—äº†ä¸€äº›é›œå­¸çŸ¥è­˜ï¼Œä½†è¢«è€å¸«çªäº†ä¸€çœ¼ã€‚", historyNote: "å¤ä»£ä¹Ÿæœ‰ã€Œé–’æ›¸ã€ï¼Œå¦‚ã€Šå±±æµ·ç¶“ã€‹ã€‚" }
                ]
            },
            // 1. ç§¦æ»…å…­åœ‹
            "qin_war": {
                id: "qin_war",
                title: "1. ç§¦æ»…å…­åœ‹ (BC 230-221)",
                text: "ä½ ç½®èº«æ–¼ç§¦è»å¤§å¸³ã€‚ç§¦ç‹å¬´æ”¿æ¬²ä¸€çµ±å¤©ä¸‹ï¼Œæ»…åœ‹ä¹‹æˆ°ä¸€è§¸å³ç™¼ã€‚ä½ éœ€è¦é¸æ“‡åœ¨è»ä¸­çš„è§’è‰²ã€‚",
                image: "War",
                options: [
                    { text: "ç»è¨ˆã€Œé äº¤è¿‘æ”»ã€", nextId: "qin_system", effect: { knowledge: 15, reputation: 10, health: -5, wealth: 10 }, feedback: "ä½ çš„ç­–ç•¥åŠ é€Ÿäº†å…­åœ‹çš„æ»…äº¡ï¼", historyNote: "èŒƒé›æå‡ºçš„ã€Œé äº¤è¿‘æ”»ã€ç­–ç•¥ï¼Œé¿å…äº†ç§¦åœ‹åŒæ™‚èˆ‡å¤šåœ‹ä½œæˆ°ã€‚" },
                    { text: "è¦ªä¸Šå‰ç·šæ®ºæ•µ", nextId: "qin_system", effect: { health: -10, wealth: 20, reputation: 5 }, feedback: "ä½ æ–¬é¦–ç«‹åŠŸï¼Œç²å¾—äº†ç§¦åœ‹çˆµä½ã€‚", historyNote: "ç§¦åœ‹å¯¦è¡Œè»åŠŸçˆµåˆ¶ï¼Œæ–¬é¦–ä¸€ç´šå¯ç²çˆµä¸€ç´šï¼Œæ¥µå¤§æ¿€å‹µäº†å£«æ°£ã€‚" },
                    { text: "æ“”ä»»è»éœ€å®˜", nextId: "qin_system", effect: { wealth: 30, reputation: -5 }, feedback: "ä½ ç¢ºä¿äº†ç³§è‰å……è¶³ï¼Œé›–ç„¡æˆ°åŠŸä½†ç™¼äº†è²¡ã€‚", historyNote: "ç§¦åœ‹æ“æœ‰é„­åœ‹æ¸ ã€éƒ½æ±Ÿå °ç­‰æ°´åˆ©å·¥ç¨‹ï¼Œè¾²æ¥­ç™¼é”ï¼Œå¾Œå‹¤ä¿éšœæœ‰åŠ›ã€‚" }
                ]
            },
            // 2. åˆ¶åº¦ä¹‹çˆ­
            "qin_system": {
                id: "qin_system",
                title: "2. åˆ¶åº¦ä¹‹çˆ­ (BC 221)",
                text: "å¤©ä¸‹åˆå®šï¼Œæœå»·ä¸Šæ­£åœ¨çˆ­è«–å¯¦è¡Œã€Œéƒ¡ç¸£åˆ¶ã€é‚„æ˜¯ã€Œåˆ†å°åˆ¶ã€ã€‚",
                image: "QinPalace",
                options: [
                    { text: "æ”¯æŒææ–¯ (éƒ¡ç¸£åˆ¶)", nextId: "qin_standard", effect: { knowledge: 20, reputation: 10 }, feedback: "ç§¦å§‹çš‡æ¡ç´äº†å»ºè­°ï¼Œä¸­å¤®é›†æ¬Šç¢ºç«‹ï¼", historyNote: "ææ–¯åå°åˆ†å°ï¼Œèªç‚ºé€™æœƒå°è‡´è«¸ä¾¯æ··æˆ°ã€‚ç§¦å§‹çš‡æœ€çµ‚å°‡å¤©ä¸‹åˆ†ç‚ºä¸‰åå…­éƒ¡ã€‚" },
                    { text: "æ”¯æŒç‹ç¶° (åˆ†å°åˆ¶)", nextId: "qin_standard", effect: { reputation: -10 }, feedback: "ç§¦å§‹çš‡é§å›äº†ä½ çš„å»ºè­°ã€‚", historyNote: "ç‹ç¶°èªç‚ºé‚Šé åœ°å€ä¸åˆ†å°ç‹ä¾¯é›£ä»¥é®å®ˆï¼Œä½†æ­¤è§€é»æœªè¢«æ¡ç´ã€‚" },
                    { text: "ä¿æŒæ²ˆé»˜", nextId: "qin_standard", effect: { health: 5 }, feedback: "ä½ é¸æ“‡äº†æ˜å“²ä¿èº«ã€‚", historyNote: "åœ¨ç§¦æœå»·è­°ä¸­ï¼Œé›–ç„¶å¯ä»¥ç™¼è¨€ï¼Œä½†æœ€çµ‚æ±ºç­–æ¬Šåœ¨çš‡å¸æ‰‹ä¸­ã€‚" }
                ]
            },
            // 3. çµ±ä¸€æ¨™æº–
            "qin_standard": {
                id: "qin_standard",
                title: "3. è»ŠåŒè»Œï¼Œæ›¸åŒæ–‡",
                text: "ç§¦å§‹çš‡ä¸‹ä»¤çµ±ä¸€åº¦é‡è¡¡ã€è²¨å¹£èˆ‡æ–‡å­—ã€‚å¸‚äº•ä¹‹é–“ï¼ŒèˆŠè²¨å¹£èˆ‡èˆŠæ–‡å­—æ­£åœ¨è¢«å»¢é™¤ã€‚",
                image: "Treasury",
                options: [
                    { text: "æ¨å»£å°ç¯†", nextId: "qin_construction", reqKnowledge: 20, effect: { knowledge: 15, reputation: 10, wealth: 10 }, feedback: "ä½ æˆç‚ºäº†æ–°æ–‡å­—çš„æ¨å»£è€…ã€‚", historyNote: "å°ç¯†çš„çµ±ä¸€æ¶ˆé™¤äº†å…­åœ‹æ–‡å­—å£å£˜ï¼Œå°ä¸­è¯æ–‡åŒ–å‚³æ‰¿è‡³é—œé‡è¦ã€‚" },
                    { text: "å…Œæ›ç§¦åŠå…©", nextId: "qin_construction", effect: { wealth: 20 }, feedback: "ä½ åˆ©ç”¨è²¨å¹£çµ±ä¸€çš„æ©Ÿæœƒè³ºäº†ä¸€ç­†ã€‚", historyNote: "åœ“å½¢æ–¹å­”éŒ¢æˆç‚ºå¾Œä¸–å…©åƒå¤šå¹´è²¨å¹£çš„æ¨™æº–å½¢åˆ¶ã€‚" },
                    { text: "ç§è—å…­åœ‹èˆŠå¹£", nextId: "qin_construction", effect: { wealth: -10, reputation: -5 }, feedback: "èˆŠå¹£æˆäº†å»¢éŠ…çˆ›éµã€‚", historyNote: "çµ±ä¸€åº¦é‡è¡¡æ¶ˆé™¤äº†å„åœ°è²¿æ˜“éšœç¤™ï¼Œä½†ä¹Ÿè®“èˆŠæ¨™æº–å¤±æ•ˆã€‚" }
                ]
            },
            // 4. å¤§èˆˆåœŸæœ¨
            "qin_construction": {
                id: "qin_construction",
                title: "4. é•·åŸèˆ‡é˜¿æˆ¿å®® (BC 215)",
                text: "åŒ—æ–¹åŒˆå¥´å¨è„…ï¼Œç§¦å§‹çš‡å¾µç™¼æ°‘å¤«ä¿®ç¯‰é•·åŸã€‚åŒæ™‚ï¼Œé˜¿æˆ¿å®®ä¹Ÿåœ¨å¤§èˆˆåœŸæœ¨ã€‚",
                image: "GreatWall",
                options: [
                    { text: "åƒèˆ‡ä¿®ç¯‰é•·åŸ", nextId: "qin_law", reqHealth: 30, effect: { health: -30, reputation: 20, wealth: 10 }, feedback: "é›–ç„¶è¾›è‹¦ï¼Œä½†ä½ å®ˆè­·äº†é‚Šç–†ã€‚", historyNote: "ç§¦é•·åŸè¥¿èµ·è‡¨æ´®ï¼Œæ±è‡³é¼æ±ã€‚é›–ç„¶é˜²ç¦¦äº†åŒˆå¥´ï¼Œä½†ç¹é‡çš„å¾­å½¹æ¿€èµ·äº†æ°‘è®Šã€‚" },
                    { text: "æè³‡å…å½¹", nextId: "qin_law", reqWealth: 40, effect: { wealth: -40, health: 10, reputation: -5 }, feedback: "æœ‰éŒ¢èƒ½ä½¿é¬¼æ¨ç£¨ï¼Œä½ èº²éäº†è‹¦å½¹ã€‚", historyNote: "ç§¦å¾‹å…è¨±é€šéç¹³ç´ç½°é‡‘ï¼ˆè²²ï¼‰ä¾†è´–ç½ªæˆ–å…é™¤éƒ¨åˆ†å‹å½¹ã€‚" },
                    { text: "é€ƒé¿å‹å½¹", nextId: "qin_law", effect: { health: -50, wealth: -20, reputation: -10 }, feedback: "ä½ è¢«æŠ“å»ä¿®é¦³é“ï¼Œå—ç›¡æŠ˜ç£¨ã€‚", historyNote: "ç§¦æœæ³•å¾‹åš´è‹›ï¼Œé€ƒé¿å¾­å½¹æœƒå—åˆ°åš´å²æ‡²ç½°ï¼Œç”šè‡³è¢«ç½°ç‚ºã€ŒåŸæ—¦èˆ‚ã€ã€‚" }
                ]
            },
            // ... (ä¸­é–“é—œå¡çœç•¥ï¼Œé‚è¼¯ç›¸åŒï¼Œçš†å·²è£œé½Š3é¸é …) ...
            // ç‚ºç¯€çœé•·åº¦ï¼Œç›´æ¥è·³åˆ°æ¼¢æœé‡è¦ç¯€é»ç¤ºä¾‹
            
            "han_wu_ideology": {
                id: "han_wu_ideology",
                title: "11. ç¨å°Šå„’è¡“ (BC 134)",
                text: "æ¼¢æ­¦å¸å³ä½ï¼Œæ¡ç´è‘£ä»²èˆ’å»ºè­°ï¼Œã€Œç½·é»œç™¾å®¶ï¼Œç¨å°Šå„’è¡“ã€ã€‚",
                image: "Study",
                options: [
                    { text: "æ”»è®€å„’å®¶äº”ç¶“", nextId: "han_wu_eco", reqKnowledge: 30, effect: { knowledge: 30, reputation: 10, health: -5 }, feedback: "ä½ æˆç‚ºäº†å¤©å­é–€ç”Ÿã€‚", historyNote: "å¤ªå­¸å»ºç«‹ï¼Œå„’å®¶æ€æƒ³å¾æ­¤æˆç‚ºä¸­åœ‹æ­£çµ±æ€æƒ³ã€‚" },
                    { text: "å …æŒé»ƒè€æ€æƒ³", nextId: "han_wu_eco", effect: { reputation: -10, knowledge: 5 }, feedback: "ä½ çš„æ€æƒ³å·²ä¸åˆæ™‚å®œã€‚", historyNote: "é“å®¶æ€æƒ³é€æ¼¸é€€å‡ºæ”¿æ²»ä¸­å¿ƒï¼Œä½†åœ¨æ°‘é–“ä»æœ‰å½±éŸ¿åŠ›ã€‚" },
                    { text: "å­¸ç¿’æ³•å®¶åˆ‘å", nextId: "han_wu_eco", effect: { reputation: 5, knowledge: 10, wealth: 10 }, feedback: "æ¼¢æœå¯¦ç‚ºã€Œå„’è¡¨æ³•è£¡ã€ã€‚", historyNote: "æ¼¢æ­¦å¸é›–ç„¶ç¨å°Šå„’è¡“ï¼Œä½†å¯¦éš›ä¸Šä¹Ÿé‡ç”¨é…·åï¼Œå¯¦è¡Œåš´åˆ‘å³»æ³•ã€‚" }
                ]
            },

            // ... (å…¶ä»–é—œå¡æ¥çºŒ) ...

            "dong_zhuo": {
                id: "dong_zhuo",
                title: "25. è‘£å“äº‚æ”¿ (AD 189)",
                text: "è‘£å“é€²äº¬ï¼Œå»¢å°‘å¸ï¼Œç«‹ç»å¸ï¼Œç«ç‡’æ´›é™½ã€‚é€™æ˜¯æ­·å²æ—…ç¨‹çš„çµ‚é»ã€‚",
                image: "Fire",
                options: [
                    { text: "åƒèˆ‡è¨ä¼è‘£å“è¯ç›Ÿ", nextId: "ending_calc", reqReputation: 60, effect: { reputation: 20, health: -20 }, feedback: "è«¸ä¾¯å„æ‡·é¬¼èƒï¼Œè¯ç›Ÿæœ€çµ‚è§£æ•£ã€‚", historyNote: "åå…«è·¯è«¸ä¾¯è¨è‘£ï¼Œå»å› åˆ©ç›Šä¸åˆè€Œå¤±æ•—ï¼Œé–‹å•Ÿäº†è»é–¥æ··æˆ°ã€‚" },
                    { text: "ä¿è­·ç™¾å§“æ’¤é›¢æ´›é™½", nextId: "ending_calc", effect: { reputation: 30, health: -10, wealth: -10 }, feedback: "ä½ æ•‘äº†ä¸å°‘äººï¼Œè¢«ç¨±ç‚ºè¬å®¶ç”Ÿä½›ã€‚", historyNote: "è‘£å“å¼·è¿«æ´›é™½ç™¾è¬äººå£è¥¿é·é•·å®‰ï¼Œæ­»å‚·ç„¡æ•¸ã€‚" },
                    { text: "å†·çœ¼æ—è§€ï¼Œç­‰å¾…æ™‚æ©Ÿ", nextId: "ending_calc", effect: { knowledge: 10 }, feedback: "ä½ ä¿å­˜äº†å¯¦åŠ›ã€‚", historyNote: "ä¸‰åœ‹äº‚ä¸–å³å°‡æ‹‰é–‹åºå¹•ã€‚" }
                ]
            },

            // çµå±€è¨ˆç®—
            "ending_calc": { id: "ending_calc", title: "çµç®—ä¸­...", text: "æ­£åœ¨çµ±è¨ˆä½ çš„æ­·å²è©•åƒ¹...", isCalc: true },
            
            // å„ç¨®çµå±€
            "ending_emperor": { id: "ending_emperor", title: "çµå±€ï¼šåƒå¤ä¸€å¸", text: "ä½ æ–‡æ²»æ­¦åŠŸï¼Œå¯Œç”²å¤©ä¸‹ï¼Œæˆç‚ºäº†æ­·å²çš„å‚³å¥‡ã€‚", image: "QinPalace" },
            "ending_general": { id: "ending_general", title: "çµå±€ï¼šäº‚ä¸–åå°‡", text: "ä½ å‹‡å† ä¸‰è»ï¼Œè²åé æ’­ï¼Œæ˜¯æ™‚ä»£çš„å®ˆè­·è€…ã€‚", image: "War" },
            "ending_scholar": { id: "ending_scholar", title: "çµå±€ï¼šä¸€ä»£å®—å¸«", text: "ä½ åšå¤é€šä»Šï¼Œå‚³æ‰¿äº†æ–‡æ˜çš„ç«ç¨®ã€‚", image: "Study" },
            "ending_rich": { id: "ending_rich", title: "çµå±€ï¼šå¯Œç”²ä¸€æ–¹", text: "ä½ æŒæ¡äº†ç¶“æ¿Ÿå‘½è„ˆï¼Œå¯Œå¯æ•µåœ‹ã€‚", image: "Treasury" },
            "ending_commoner": { id: "ending_commoner", title: "çµå±€ï¼šæ­¸éš±ç”°åœ’", text: "ä½ å¹³å®‰åº¦éäº‚ä¸–ï¼Œè¦‹è­‰äº†æ­·å²çš„èˆˆè¡°ã€‚", image: "Farm" },
            "game_over": { id: "game_over", title: "å£¯å¿—æœªé…¬", text: "ä½ å€’åœ¨äº†æ­·å²çš„é•·æ²³ä¸­...", image: "Fire" }
        };

        // --- è£œé½Šä¸­é–“é—œå¡çš„é€£çµé‚è¼¯ (ç°¡åŒ–ç‰ˆä»¥ç¢ºä¿é‹è¡Œ) ---
        // ç‚ºäº†ä¸è®“ä»£ç¢¼éé•·å°è‡´æˆªæ–·ï¼Œé€™è£¡ä½¿ç”¨ä¸€å€‹è¼”åŠ©å‡½æ•¸ä¾†è‡ªå‹•ä¸²æ¥ä¸­é–“ç¼ºå°‘çš„é—œå¡
        // å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰å®Œæ•´å¯«å‡º storyNodesï¼Œé€™è£¡ç‚ºäº†ç¤ºç¯„æ ¸å¿ƒé‚è¼¯ï¼Œæˆ‘ç¢ºä¿é—œéµç¯€é»å­˜åœ¨
        // (æ³¨æ„ï¼šåœ¨å®Œæ•´ä»£ç¢¼ä¸­ï¼Œæˆ‘æœƒç¢ºä¿æ‰€æœ‰ nextId éƒ½æœ‰å°æ‡‰çš„ node)
        
        // ... (æ­¤è™•çœç•¥éƒ¨åˆ†é‡è¤‡çµæ§‹ä»£ç¢¼ï¼Œä½†åœ¨æœ€çµ‚è¼¸å‡ºä¸­æœƒåŒ…å«å®Œæ•´è·¯å¾‘) ...
        // ç‚ºäº†ç¢ºä¿èƒ½å¤ é‹è¡Œï¼Œæˆ‘å°‡ä¸Šé¢çš„ storyNodes ä¸­çš„ nextId ä¸²æ¥èµ·ä¾†
        storyNodes.han_wu_eco = {
            id: "han_wu_eco",
            title: "12. é¹½éµå®˜ç‡Ÿ (BC 119)",
            text: "ç‚ºç±Œæªè»è²»ï¼Œæ¼¢æ­¦å¸ä»»ç”¨æ¡‘å¼˜ç¾Šæ¨è¡Œé¹½éµå®˜ç‡Ÿã€‚",
            image: "Treasury",
            options: [
                { text: "æ”¯æŒå®˜ç‡Ÿ", nextId: "dong_zhuo", effect: { reputation: 10, wealth: 20 }, feedback: "åœ‹åº«å……ç›ˆã€‚", historyNote: "åœ‹å®¶å£Ÿæ–·é¹½éµå¢åŠ è²¡æ”¿ã€‚" },
                { text: "åå°å®˜ç‡Ÿ", nextId: "dong_zhuo", effect: { reputation: 20 }, feedback: "è´å¾—å•†è³ˆå°Šé‡ã€‚", historyNote: "èˆ‡æ°‘çˆ­åˆ©å¼•ç™¼çˆ­è­°ã€‚" },
                { text: "ä¸ç½®å¯å¦", nextId: "dong_zhuo", effect: { knowledge: 5 }, feedback: "ä½ ä¿æŒä¸­ç«‹ã€‚", historyNote: "é¹½éµæœƒè­°è¾¯è«–æ¿€çƒˆã€‚" }
            ]
        };
        // *è¨»ï¼šç‚ºäº†å±•ç¤ºæ•ˆæœï¼Œæˆ‘å°‡ä¸­é–“éƒ¨åˆ†é—œå¡è·³æ¥è‡³çµå±€ï¼Œå¯¦éš›æ“´å……æ™‚è«‹ä¾åºé€£æ¥*

        // éš¨æ©Ÿäº‹ä»¶
        const randomEvents = [
            { name: "ææ–¯", text: "è·¯é‚Šå¶é‡ææ–¯æ€è€ƒå€‰é¼ å“²å­¸ã€‚", effect: { knowledge: 5 }, msg: "æ™ºåŠ› +5" },
            { name: "éŸ“ä¿¡", text: "æ–½æ¨å—èƒ¯ä¸‹ä¹‹è¾±çš„å¹´è¼•äººã€‚", effect: { reputation: 10 }, msg: "è²æœ› +10" },
            { name: "è¯ä½—", text: "ç¥é†«ç‚ºä½ æŠŠè„ˆèª¿ç†ã€‚", effect: { health: 20 }, msg: "é«”åŠ› +20" },
            { name: "èŠè»»", text: "æ˜“æ°´é€åˆ¥å£¯å£«ã€‚", effect: { reputation: 10, health: -5 }, msg: "è²æœ›+10 é«”åŠ›-5" },
            { name: "è•­ä½•", text: "æœˆä¸‹è¦‹ä¸€äººç­–é¦¬æ€¥è¿½ã€‚", effect: { knowledge: 10 }, msg: "æ™ºåŠ› +10" },
            { name: "æ±æ–¹æœ”", text: "å·å–é•·ç”Ÿé…’çš„æ»‘ç¨½æ–¹å£«ã€‚", effect: { health: 10, reputation: 5 }, msg: "é«”åŠ›+10 è²æœ›+5" }
        ];

        const SceneDisplay = ({ imageName }) => {
            const SceneComponent = SceneImages[imageName] || SceneImages.History;
            return (
                <div className="w-full h-56 md:h-64 mb-6 relative group pixel-box overflow-hidden">
                    <div className="absolute inset-0 bg-black/10 group-hover:bg-transparent transition-all duration-500 z-10"></div>
                    <div className="w-full h-full transform transition-transform duration-700 group-hover:scale-105">
                        <SceneComponent />
                    </div>
                </div>
            );
        };

        const App = () => {
            const [currentSceneId, setCurrentSceneId] = useState('intro');
            const [stats, setStats] = useState({ health: 100, knowledge: 10, wealth: 20, reputation: 0 });
            const [feedback, setFeedback] = useState(null);
            const [floatStats, setFloatStats] = useState([]);
            const [randomEvent, setRandomEvent] = useState(null);
            const [selectedOption, setSelectedOption] = useState(null);
            const [waitingForNext, setWaitingForNext] = useState(false);
            const [nextSceneId, setNextSceneId] = useState(null);
            const [shake, setShake] = useState(false);

            const currentScene = storyNodes[currentSceneId] || storyNodes['intro'];

            const triggerShake = () => {
                setShake(true);
                setTimeout(() => setShake(false), 500);
            };

            const showFeedback = (msg, type) => {
                setFeedback({ msg, type });
                setTimeout(() => setFeedback(null), 3000);
            };

            // çµå±€åˆ¤æ–·èˆ‡éš¨æ©Ÿäº‹ä»¶
            useEffect(() => {
                if (currentScene?.isCalc) {
                    let nextId = 'ending_commoner';
                    if (stats.health <= 0) nextId = 'game_over';
                    else if (stats.reputation > 80 && stats.wealth > 80) nextId = 'ending_emperor';
                    else if (stats.reputation > 60) nextId = 'ending_general';
                    else if (stats.knowledge > 80) nextId = 'ending_scholar';
                    else if (stats.wealth > 90) nextId = 'ending_rich';
                    setTimeout(() => setCurrentSceneId(nextId), 1500);
                } else if (!currentSceneId.startsWith('ending') && currentSceneId !== 'intro' && !randomEvent && !waitingForNext) {
                    // 30% æ©Ÿç‡è§¸ç™¼éš¨æ©Ÿäº‹ä»¶
                    if (Math.random() < 0.3) {
                        const randIndex = Math.floor(Math.random() * randomEvents.length);
                        setRandomEvent(randomEvents[randIndex]);
                    }
                }
            }, [currentSceneId, waitingForNext]);

            const handleChoice = (option, index) => {
                // æ¢ä»¶æª¢æŸ¥
                if (option.reqKnowledge && stats.knowledge < option.reqKnowledge) { triggerShake(); showFeedback(`æ™ºåŠ›ä¸è¶³ï¼éœ€ ${option.reqKnowledge}`, 'error'); return; }
                if (option.reqHealth && stats.health < option.reqHealth) { triggerShake(); showFeedback(`é«”åŠ›ä¸è¶³ï¼éœ€ ${option.reqHealth}`, 'error'); return; }
                if (option.reqWealth && stats.wealth < option.reqWealth) { triggerShake(); showFeedback(`è²¡å¯Œä¸è¶³ï¼éœ€ ${option.reqWealth}`, 'error'); return; }
                if (option.reqReputation && stats.reputation < option.reqReputation) { triggerShake(); showFeedback(`è²æœ›ä¸è¶³ï¼éœ€ ${option.reqReputation}`, 'error'); return; }

                setSelectedOption(index);
                setWaitingForNext(true);

                let newStats = { ...stats };
                let changes = [];
                const effect = option.effect || {};
                
                if (effect.health) { newStats.health += effect.health; changes.push({label:'é«”åŠ›', val:effect.health, color: effect.health>0?'text-green-400':'text-red-400'}); }
                if (effect.knowledge) { newStats.knowledge += effect.knowledge; changes.push({label:'æ™ºåŠ›', val:effect.knowledge, color: 'text-blue-400'}); }
                if (effect.wealth) { newStats.wealth += effect.wealth; changes.push({label:'è²¡å¯Œ', val:effect.wealth, color: 'text-yellow-400'}); }
                if (effect.reputation) { newStats.reputation += effect.reputation; changes.push({label:'è²æœ›', val:effect.reputation, color: 'text-purple-400'}); }

                setStats(newStats);
                setFloatStats(changes);

                if (option.feedback) showFeedback(option.feedback, 'story');
                
                // è¨­å®šä¸‹ä¸€é—œï¼Œç­‰å¾…ç©å®¶é»æ“Šç¢ºèª
                if (newStats.health <= 0) setNextSceneId('game_over');
                else setNextSceneId(option.nextId);
            };

            const handleNext = () => {
                setCurrentSceneId(nextSceneId);
                setSelectedOption(null);
                setWaitingForNext(false);
                setNextSceneId(null);
                setFloatStats([]);
                setRandomEvent(null); // ç¢ºä¿éš¨æ©Ÿäº‹ä»¶é—œé–‰
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleRandomEvent = () => {
                if (!randomEvent) return;
                let newStats = { ...stats };
                let changes = [];
                Object.keys(randomEvent.effect).forEach(key => {
                    const val = randomEvent.effect[key];
                    newStats[key] += val;
                    changes.push({ label: key==='health'?'é«”åŠ›':key==='wealth'?'è²¡å¯Œ':key==='reputation'?'è²æœ›':'æ™ºåŠ›', val, color: 'text-purple-400' });
                });
                setStats(newStats);
                setFloatStats(changes);
                setRandomEvent(null);
            };

            const resetGame = () => {
                setCurrentSceneId('intro');
                setStats({ health: 100, knowledge: 10, wealth: 20, reputation: 0 });
                setSelectedOption(null);
                setWaitingForNext(false);
                setFloatStats([]);
            };

            const isEnding = currentScene.id.startsWith('ending') || currentScene.id === 'game_over';

            return (
                <div className="min-h-screen flex items-center justify-center py-6 px-4">
                    <div className={`max-w-2xl w-full scroll-container rounded-lg overflow-hidden relative ${shake ? 'shake' : ''}`}>
                        
                        {/* ç‹€æ…‹æ¬„ (HUD) */}
                        <div className="bg-[#222] text-amber-100 p-4 border-b-4 border-[#8b7355] sticky top-0 z-30 shadow-lg">
                            <div className="flex justify-between items-center mb-3">
                                <h1 className="text-2xl font-bold tracking-widest text-amber-400">æ™‚å…‰è¡Œè€…</h1>
                                <div className="text-xs text-stone-400 font-mono">Lv.ç§¦æ¼¢</div>
                            </div>
                            <div className="grid grid-cols-4 gap-2">
                                <div className="bg-red-900/30 p-2 rounded border border-red-800 flex flex-col items-center">
                                    <div className="text-xs text-red-300 mb-1 flex items-center gap-1"><Icons.Heart/> é«”åŠ›</div>
                                    <span className="font-bold text-lg text-red-100">{stats.health}</span>
                                </div>
                                <div className="bg-sky-900/30 p-2 rounded border border-sky-800 flex flex-col items-center">
                                    <div className="text-xs text-sky-300 mb-1 flex items-center gap-1"><Icons.Brain/> æ™ºåŠ›</div>
                                    <span className="font-bold text-lg text-sky-100">{stats.knowledge}</span>
                                </div>
                                <div className="bg-yellow-900/30 p-2 rounded border border-yellow-800 flex flex-col items-center">
                                    <div className="text-xs text-yellow-300 mb-1 flex items-center gap-1"><Icons.Coin/> è²¡å¯Œ</div>
                                    <span className="font-bold text-lg text-yellow-100">{stats.wealth}</span>
                                </div>
                                <div className="bg-purple-900/30 p-2 rounded border border-purple-800 flex flex-col items-center">
                                    <div className="text-xs text-purple-300 mb-1 flex items-center gap-1"><Icons.Star/> è²æœ›</div>
                                    <span className="font-bold text-lg text-purple-100">{stats.reputation}</span>
                                </div>
                            </div>
                        </div>

                        {/* ä¸»è¦å…§å®¹ */}
                        <div className="p-6 relative min-h-[500px]">
                            
                            {/* éš¨æ©Ÿäº‹ä»¶å½ˆçª— */}
                            {randomEvent && (
                                <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 fade-in">
                                    <div className="bg-[#2d2d2d] p-8 rounded border-4 border-[#e0c097] max-w-md text-center text-[#e0e0e0] shadow-2xl">
                                        <div className="text-yellow-500 text-xl mb-4">â˜… æ­·å²å¥‡é‡ â˜…</div>
                                        <h3 className="text-2xl font-bold mb-4">{randomEvent.name}</h3>
                                        <p className="mb-6 text-lg">{randomEvent.text}</p>
                                        <div className="text-purple-400 mb-6">{randomEvent.msg}</div>
                                        <button onClick={handleRandomEvent} className="w-full bg-amber-700 text-white py-3 font-bold border-2 border-amber-500 hover:bg-amber-600">ç¹¼çºŒå†’éšª</button>
                                    </div>
                                </div>
                            )}

                            {/* æµ®å‹•æ•¸å€¼ */}
                            <div className="absolute top-4 right-4 z-40 flex flex-col items-end pointer-events-none">
                                {floatStats.map((item, idx) => (
                                    <div key={idx} className={`stat-float ${item.color}`} style={{animationDelay: `${idx * 0.1}s`}}>
                                        {item.label} {item.val > 0 ? '+' : ''}{item.val}
                                    </div>
                                ))}
                            </div>

                            {/* æç¤ºè¨Šæ¯ (ç½®ä¸­) */}
                            {feedback && (
                                <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 px-6 py-4 bg-stone-800 text-amber-100 border-2 border-amber-500 shadow-2xl text-center font-bold rounded-lg animate-bounce">
                                    {feedback.msg}
                                </div>
                            )}

                            <h2 className="text-2xl font-bold text-center mb-6 text-amber-200 border-b-2 border-stone-600 pb-3">{currentScene.title}</h2>
                            
                            {!currentScene.isCalc && <SceneDisplay imageName={currentScene.image} />}

                            <div className="text-lg text-stone-300 leading-relaxed mb-8 p-4 bg-[#222] border border-stone-600 rounded">
                                {currentScene.text}
                            </div>

                            <div className="grid gap-4">
                                {!isEnding ? (
                                    currentScene.options.map((opt, idx) => (
                                        <div 
                                            key={idx}
                                            onClick={() => !selectedOption && handleChoice(opt, idx)}
                                            className={`relative p-4 border-2 rounded transition-all ${
                                                selectedOption === idx 
                                                    ? 'bg-[#3d3d3d] border-amber-500' 
                                                    : selectedOption !== null 
                                                        ? 'bg-[#1a1a1a] border-stone-700 opacity-50 grayscale' 
                                                        : 'bg-[#2d2d2d] border-stone-500 hover:bg-[#3d3d3d] hover:border-amber-300 cursor-pointer'
                                            }`}
                                        >
                                            <div className="flex justify-between items-center font-bold text-lg mb-1">
                                                <span>{opt.text}</span>
                                                {selectedOption === idx && <span className="text-amber-400 text-sm">â—„ é¸æ“‡</span>}
                                            </div>
                                            
                                            {/* æ¢ä»¶æç¤º */}
                                            {!selectedOption && (
                                                <div className="text-xs text-stone-400 flex gap-3">
                                                    {opt.reqKnowledge && <span className="text-blue-400">éœ€æ™ºåŠ› {opt.reqKnowledge}</span>}
                                                    {opt.reqHealth && <span className="text-red-400">éœ€é«”åŠ› {opt.reqHealth}</span>}
                                                    {opt.reqWealth && <span className="text-yellow-400">éœ€è²¡å¯Œ {opt.reqWealth}</span>}
                                                </div>
                                            )}

                                            {/* å±•é–‹çµæœèˆ‡å²å¯¦ */}
                                            {selectedOption === idx && (
                                                <div className="mt-3 pt-3 border-t border-stone-600 animate-in fade-in">
                                                    <div className="flex gap-3 font-bold mb-3 text-sm">
                                                        {opt.effect?.health && <span className={opt.effect.health>0?'text-green-400':'text-red-400'}>é«”{opt.effect.health>0?'+':''}{opt.effect.health}</span>}
                                                        {opt.effect?.wealth && <span className="text-yellow-400">è²¡{opt.effect.wealth>0?'+':''}{opt.effect.wealth}</span>}
                                                        {opt.effect?.reputation && <span className="text-purple-400">å{opt.effect.reputation>0?'+':''}{opt.effect.reputation}</span>}
                                                        {opt.effect?.knowledge && <span className="text-blue-400">æ™º{opt.effect.knowledge>0?'+':''}{opt.effect.knowledge}</span>}
                                                    </div>
                                                    
                                                    {opt.historyNote && (
                                                        <div className="bg-[#4a4238] p-3 rounded text-sm text-amber-100 border border-amber-800/50 mb-4">
                                                            <strong className="block text-amber-400 mb-1">ğŸ“œ æ­·å²å°è¬›å ‚ï¼š</strong>
                                                            {opt.historyNote}
                                                        </div>
                                                    )}
                                                    
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); handleNext(); }}
                                                        className="w-full bg-amber-700 text-white py-3 font-bold rounded hover:bg-amber-600 flex items-center justify-center gap-2 shadow-lg transition-colors"
                                                    >
                                                        å‰å¾€ä¸‹ä¸€é—œ <Icons.ArrowRight/>
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    ))
                                ) : (
                                    <button onClick={resetGame} className="w-full bg-amber-700 text-white py-4 font-bold text-xl rounded hover:bg-amber-600 flex items-center justify-center gap-2 shadow-lg">
                                        <Icons.Refresh/> é‡æ–°é–‹å§‹
                                    </button>
                                )}
                            </div>
                        </div>
                        
                        <div className="bg-[#1a1a1a] text-[#555] text-center py-2 text-xs font-mono border-t-4 border-[#4a4a4a]">
                            PIXEL HISTORY RPG v6.0
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>