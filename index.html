<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚å…‰è¡Œè€…ï¼šç§¦æ¼¢é¢¨é›² (æœ€çµ‚å®Œç¾ä¿®å¾©ç‰ˆ)</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <!-- å¼•å…¥ Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- å¼•å…¥åƒç´ å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        body {
            font-family: 'DotGothic16', 'Noto Serif TC', monospace;
            background-color: #1a1a1a;
            color: #e0e0e0;
            overflow-x: hidden;
            /* å¾©å¤ç¶²æ ¼èƒŒæ™¯ */
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* --- éŠæˆ²å®¹å™¨ --- */
        .game-container {
            background-color: #222034; /* æ·±ç´«ç°åº•è‰² */
            border: 4px solid #5C5B7F;
            box-shadow: 
                0 0 0 4px #1a1a1a,
                0 20px 50px rgba(0,0,0,0.9);
            position: relative;
        }

        /* --- æ ¸å¿ƒä¿®å¾©ï¼šåƒç´ è‰²å¡Šé¸é …æŒ‰éˆ• --- */
        .option-block {
            position: relative;
            display: block;
            width: 100%;
            background-color: #383850; /* é è¨­æ·±è‰²å¡Š */
            color: #fff;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            
            /* åƒç´ ç«‹é«”é‚Šæ¡†æ•ˆæœ */
            border: 3px solid;
            border-color: #5d5d8a #1e1e2e #1e1e2e #5d5d8a; /* å·¦ä¸Šäº®ï¼Œå³ä¸‹æš— */
            
            /* ç¡¬é™°å½± */
            box-shadow: 4px 4px 0px #111;
            
            transition: transform 0.1s, background-color 0.1s;
            text-align: left;
        }

        /* æ»‘é¼ æ‡¸åœ */
        .option-block:hover:not(.disabled):not(.selected) {
            background-color: #4b4b70;
            transform: translate(-1px, -1px);
            box-shadow: 5px 5px 0px #111;
            border-color: #7a7aae #2a2a4a #2a2a4a #7a7aae;
        }

        /* é¸ä¸­ç‹€æ…‹ (é‡‘è‰²é«˜äº®) */
        .option-block.selected {
            background-color: #e6c229; /* é‡‘è‰² */
            color: #2a2a4a; /* æ·±è‰²æ–‡å­— */
            border-color: #ffe66d #b39200 #b39200 #ffe66d;
            transform: translate(2px, 2px); /* ä¸‹å£“æ•ˆæœ */
            box-shadow: 2px 2px 0px #111; /* é™°å½±è®Šå° */
            cursor: default;
        }

        /* ç¦ç”¨/æœªé¸ä¸­ç‹€æ…‹ (è®Šæš—) */
        .option-block.disabled {
            background-color: #252530;
            color: #555;
            border-color: #333 #111 #111 #333;
            transform: translate(2px, 2px);
            box-shadow: none;
            cursor: not-allowed;
        }

        /* --- ä¸‹ä¸€æ­¥æŒ‰éˆ• (ç¶ è‰²) --- */
        .next-btn {
            background-color: #4caf50;
            border: 3px solid;
            border-color: #81c784 #2e7d32 #2e7d32 #81c784;
            color: white;
            box-shadow: 2px 2px 0 #111;
        }
        .next-btn:hover { background-color: #66bb6a; }
        .next-btn:active { transform: translate(2px, 2px); box-shadow: none; border-color: #2e7d32; }

        /* --- åœ–ç‰‡å®¹å™¨ --- */
        .scene-image-container {
            border: 4px solid #2b2b2b;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            image-rendering: pixelated; /* åƒç´ åœ–ä¸æ¨¡ç³Š */
            background-color: #000;
            min-height: 250px;
        }

        /* --- é€²åº¦æ¢ --- */
        .progress-container {
            background-color: #111;
            border: 2px solid #444;
            height: 16px;
            position: relative;
            border-radius: 2px;
        }
        .progress-fill {
            height: 100%;
            transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); /* å½ˆæ€§å‹•ç•« */
        }

        /* --- æµ®å‹•æ•¸å€¼ --- */
        .stat-float {
            position: absolute;
            animation: floatUp 2s ease-out forwards;
            font-weight: 900;
            pointer-events: none;
            z-index: 100;
            text-shadow: 2px 2px 0px #000;
            font-size: 1.4rem;
            color: #F8F4A6;
        }
        @keyframes floatUp {
            0% { opacity: 0; transform: translateY(10px); }
            20% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }
        
        /* éœ‡å‹• */
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
            40%, 60% { transform: translate3d(8px, 0, 0); }
        }

        /* æ»¾å‹•æ¢ */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #222034; }
        ::-webkit-scrollbar-thumb { background: #5C5B7F; border: 2px solid #222034; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- éŸ³æ•ˆç³»çµ± ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playSound = (type) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            switch (type) {
                case 'type': // æ‰“å­—è²
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(800 + Math.random()*200, now);
                    gainNode.gain.setValueAtTime(0.03, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.03);
                    oscillator.start(now);
                    oscillator.stop(now + 0.03);
                    break;
                case 'select': // é»æ“Šè²
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(220, now);
                    oscillator.frequency.linearRampToValueAtTime(440, now + 0.1);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.linearRampToValueAtTime(0.01, now + 0.1);
                    oscillator.start(now);
                    oscillator.stop(now + 0.1);
                    break;
                case 'confirm': // ç¢ºèªè²
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(440, now);
                    oscillator.frequency.setValueAtTime(880, now + 0.1);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.linearRampToValueAtTime(0.01, now + 0.3);
                    oscillator.start(now);
                    oscillator.stop(now + 0.3);
                    break;
                case 'error': // éŒ¯èª¤è²
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(150, now);
                    oscillator.frequency.linearRampToValueAtTime(100, now + 0.2);
                    gainNode.gain.setValueAtTime(0.2, now);
                    gainNode.gain.linearRampToValueAtTime(0.01, now + 0.2);
                    oscillator.start(now);
                    oscillator.stop(now + 0.2);
                    break;
            }
        };

        // --- æ‰“å­—æ©Ÿçµ„ä»¶ ---
        const TypewriterText = ({ text, onComplete }) => {
            const [displayedText, setDisplayedText] = useState('');
            const indexRef = useRef(0);
            
            useEffect(() => {
                setDisplayedText('');
                indexRef.current = 0;
                const timer = setInterval(() => {
                    if (indexRef.current < text.length) {
                        const char = text.charAt(indexRef.current);
                        setDisplayedText((prev) => prev + char);
                        if (char !== ' ' && Math.random() > 0.6) playSound('type'); // éš¨æ©Ÿè§¸ç™¼æ‰“å­—éŸ³
                        indexRef.current++;
                    } else {
                        clearInterval(timer);
                        if (onComplete) onComplete();
                    }
                }, 20);
                return () => clearInterval(timer);
            }, [text]);

            return <span>{displayedText}</span>;
        };

        // --- é€²åº¦æ¢çµ„ä»¶ (åƒç´ é¢¨æ ¼) ---
        const StatBar = ({ label, value, max = 150, color, icon }) => {
            const percent = Math.min(100, Math.max(0, (value / max) * 100));
            return (
                <div className="flex items-center gap-2 mb-2">
                    <div className="w-6 text-center text-xl filter drop-shadow-md">{icon}</div>
                    <div className="w-10 text-xs font-bold text-gray-300 text-right tracking-widest">{label}</div>
                    <div className="flex-grow progress-container">
                        <div className={`progress-fill ${color}`} style={{ width: `${percent}%` }}></div>
                    </div>
                    <div className="w-8 text-right text-xs font-mono text-white drop-shadow">{value}</div>
                </div>
            );
        };

        // --- åœ–ç‰‡è·¯å¾‘ (æœ¬åœ°æª”æ¡ˆ) ---
        const SceneImages = {
            Classroom: "1.Classroom.webp",
            QinPalace: "2.QinPalace.webp",
            GreatWall: "3.GreatWall.webp",
            War: "4.War.webp",
            Farm: "5.Farm.webp",
            Desert: "6.Desert.webp",
            Study: "7.Study.webp",
            Treasury: "8.Treasury.webp",
            Fire: "9.Fire.webp",
            Prison: "10.Prison.webp",
            Map: "6.Desert.webp", 
            Crown: "2.QinPalace.webp", 
            Scroll: "7.Study.webp", 
            Hammer: "3.GreatWall.webp", 
            Scale: "8.Treasury.webp", 
            History: "7.Study.webp", 
            Award: "2.QinPalace.webp", 
            GameOver: "9.Fire.webp" 
        };

        // --- UI åœ–ç¤º ---
        const Icons = {
            Heart: () => <span>â¤ï¸</span>,
            Brain: () => <span>ğŸ§¿</span>,
            Coin: () => <span>ğŸª™</span>,
            Star: () => <span>ğŸ‘‘</span>,
            ArrowRight: () => <span>â–¶</span>,
            Refresh: () => <span>â†º</span>
        };

        // --- æ­·å²åŠ‡æœ¬è³‡æ–™ (å®Œæ•´ 25 é—œ) ---
        const storyNodes = {
            "intro": { id: "intro", title: "åºç« ï¼šæ­·å²çš„å¬å–š", text: "è¥¿å…ƒ2024å¹´ã€‚æ­·å²èª²ä¸Šï¼Œè€å¸«è¬›è¿°è‘—ï¼šã€Œç§¦çš‡æ¼¢æ­¦ï¼Œç•¥è¼¸æ–‡é‡‡...ã€ä½ çš„æ€ç·’é£„å‘äº†å…©åƒå¹´å‰çš„æ™‚ç©ºæ¼©æ¸¦ã€‚", image: "Classroom", options: [{ text: "èªçœŸè½èª²", nextId: "qin_war", effect: { knowledge: 10 }, feedback: "çŸ¥è­˜å°±æ˜¯åŠ›é‡ã€‚", historyNote: "æ­·å²å­¸ç¿’èƒ½å¹«åŠ©æˆ‘å€‘ä»¥å¤é‘‘ä»Šã€‚" }, { text: "ç¡è¦ºå„²å­˜é«”åŠ›", nextId: "qin_war", effect: { health: 10 }, feedback: "ç²¾ç¥é£½æ»¿åœ°ç©¿è¶Šäº†ã€‚", historyNote: "ç©¿è¶Šæ•…äº‹å¾€å¾€å§‹æ–¼æ„å¤–ã€‚" }, { text: "å·çœ‹èª²å¤–æ›¸", nextId: "qin_war", effect: { wealth: 5, reputation: -5 }, feedback: "ç²å¾—äº†ä¸€äº›é›œå­¸ã€‚", historyNote: "å¤ä»£ä¹Ÿæœ‰é–’æ›¸ã€‚" }] },
            "qin_war": { id: "qin_war", title: "1. ç§¦æ»…å…­åœ‹ (BC 230-221)", text: "ä½ ç½®èº«æ–¼ç§¦è»å¤§å¸³ã€‚ç§¦ç‹å¬´æ”¿æ¬²ä¸€çµ±å¤©ä¸‹ï¼Œæ»…åœ‹ä¹‹æˆ°ä¸€è§¸å³ç™¼ã€‚", image: "War", options: [{ text: "ç»è¨ˆã€Œé äº¤è¿‘æ”»ã€", nextId: "qin_system", reqKnowledge: 15, effect: { knowledge: 15, reputation: 10, health: -5, wealth: 10 }, feedback: "ç­–ç•¥è¢«æ¡ç´ï¼", historyNote: "èŒƒé›æå‡ºçš„æˆ°ç•¥ã€‚" }, { text: "è¦ªä¸Šå‰ç·šæ®ºæ•µ", nextId: "qin_system", effect: { health: -10, wealth: 20, reputation: 5 }, feedback: "ç²å¾—è»åŠŸçˆµä½ã€‚", historyNote: "ç§¦åœ‹å¯¦è¡Œè»åŠŸçˆµåˆ¶ã€‚" }, { text: "æ“”ä»»è»éœ€å®˜", nextId: "qin_system", reqWealth: 10, effect: { wealth: 30, reputation: -5 }, feedback: "ç¢ºä¿ç³§è‰å……è¶³ã€‚", historyNote: "ç§¦åœ‹è¾²æ¥­ç™¼é”ã€‚" }] },
            "qin_system": { id: "qin_system", title: "2. åˆ¶åº¦ç¢ºç«‹ (BC 221)", text: "æœå»·çˆ­è«–å¯¦è¡Œã€Œéƒ¡ç¸£åˆ¶ã€é‚„æ˜¯ã€Œåˆ†å°åˆ¶ã€ã€‚", image: "QinPalace", options: [{ text: "æ”¯æŒææ–¯(éƒ¡ç¸£)", nextId: "qin_standard", effect: { knowledge: 20, reputation: 10 }, feedback: "ä¸­å¤®é›†æ¬Šç¢ºç«‹ï¼", historyNote: "ææ–¯åå°åˆ†å°ã€‚" }, { text: "æ”¯æŒç‹ç¶°(åˆ†å°)", nextId: "qin_standard", reqReputation: 10, effect: { reputation: -10, health: -5 }, feedback: "å»ºè­°è¢«é§å›ã€‚", historyNote: "ç‹ç¶°èªç‚ºé‚Šé é›£æ²»ã€‚" }, { text: "æå‡ºæŠ˜ä¸­æ–¹æ¡ˆ", nextId: "qin_standard", reqKnowledge: 20, effect: { knowledge: 10, reputation: 5 }, feedback: "å±•ç¾äº†æ™ºæ…§ã€‚", historyNote: "å¾Œä¾†çš„éƒ¡åœ‹ä¸¦è¡Œåˆ¶ã€‚" }] },
            "qin_standard": { id: "qin_standard", title: "3. çµ±ä¸€åº¦é‡è¡¡", text: "ç§¦å§‹çš‡ä¸‹ä»¤çµ±ä¸€åº¦é‡è¡¡èˆ‡æ–‡å­—ã€‚", image: "Treasury", options: [{ text: "æ¨å»£å°ç¯†", nextId: "qin_construction", reqKnowledge: 30, effect: { knowledge: 15, reputation: 10, wealth: 10 }, feedback: "æ–‡åŒ–å‚³æ‰¿ã€‚", historyNote: "æ›¸åŒæ–‡ã€‚" }, { text: "å…Œæ›ç§¦åŠå…©", nextId: "qin_construction", effect: { wealth: 20 }, feedback: "è³‡ç”¢ä¿å€¼ã€‚", historyNote: "çµ±ä¸€è²¨å¹£ã€‚" }, { text: "ç§è—èˆŠå¹£", nextId: "qin_construction", effect: { knowledge: -10, health: -20 }, feedback: "å› æŠ—æ³•å—å‚·ã€‚", historyNote: "èˆŠæ¨™æº–å¤±æ•ˆã€‚" }] },
            "qin_construction": { id: "qin_construction", title: "4. å¤§èˆˆåœŸæœ¨", text: "ä¿®ç¯‰é•·åŸèˆ‡é˜¿æˆ¿å®®ã€‚", image: "GreatWall", options: [{ text: "åƒèˆ‡ä¿®é•·åŸ", nextId: "qin_law", reqHealth: 30, effect: { health: -30, reputation: 20, wealth: 10 }, feedback: "å®ˆè­·é‚Šç–†ã€‚", historyNote: "å­Ÿå§œå¥³å“­é•·åŸã€‚" }, { text: "æè³‡å…å½¹", nextId: "qin_law", reqWealth: 40, effect: { wealth: -40, health: 10, reputation: -5 }, feedback: "èº²éè‹¦å½¹ã€‚", historyNote: "ä»¥è²²è´–ç½ªã€‚" }, { text: "é€ƒé¿å‹å½¹", nextId: "qin_law", effect: { health: -50, wealth: -20, reputation: -10 }, feedback: "è¢«æŠ“å—ç½°ã€‚", historyNote: "ç§¦æ³•åš´è‹›ã€‚" }] },
            "qin_law": { id: "qin_law", title: "5. åš´åˆ‘å³»æ³•", text: "é€£åæ³•å¯¦æ–½ä¸­ã€‚", image: "Prison", options: [{ text: "èˆ‰å ±é„°å±…", nextId: "qin_burn", effect: { wealth: 30, reputation: -20 }, feedback: "ç²è³å¤±äººå¿ƒã€‚", historyNote: "ä»€ä¼é€£åã€‚" }, { text: "å¹«åŠ©éš±ç", nextId: "qin_burn", effect: { reputation: 20, health: -20 }, feedback: "ä¿ä½é„°å±…ã€‚", historyNote: "å„’å®¶è¦ªè¦ªç›¸éš±ã€‚" }, { text: "é‘½ç ”ç§¦å¾‹", nextId: "qin_burn", effect: { knowledge: 20, reputation: -10 }, feedback: "æˆç‚ºåˆ€ç­†åã€‚", historyNote: "ä»¥åç‚ºå¸«ã€‚" }] },
            "qin_burn": { id: "qin_burn", title: "6. ç„šæ›¸å‘å„’", text: "å’¸é™½åŸç«å…‰æ²–å¤©ã€‚", image: "Fire", options: [{ text: "å†’æ­»è—æ›¸", nextId: "qin_end", reqHealth: 20, effect: { reputation: 30, health: -20, knowledge: 10 }, feedback: "ä¿å­˜ç«ç¨®ã€‚", historyNote: "æ–‡åŒ–æµ©åŠ«ã€‚" }, { text: "äº¤å‡ºè—æ›¸", nextId: "qin_end", effect: { reputation: -10, knowledge: -5 }, feedback: "é¸æ“‡ç”Ÿå­˜ã€‚", historyNote: "å…¸ç±å¤±å‚³ã€‚" }, { text: "å†·çœ¼æ—è§€", nextId: "qin_end", effect: { health: 5 }, feedback: "æ˜å“²ä¿èº«ã€‚", historyNote: "çŸ¥è­˜åˆ†å­å¤±æœ›ã€‚" }] },
            "qin_end": { id: "qin_end", title: "7. ç§¦æœæ»…äº¡", text: "å¤©ä¸‹å¤§äº‚ï¼ŒåŠ‰é‚¦å…µè‡¨å’¸é™½ã€‚", image: "War", options: [{ text: "æŠ•é åŠ‰é‚¦", nextId: "han_early", effect: { knowledge: 10, reputation: 10, wealth: 10 }, feedback: "ç´„æ³•ä¸‰ç« ã€‚", historyNote: "å¾—æ°‘å¿ƒè€…å¾—å¤©ä¸‹ã€‚" }, { text: "æŠ•é é …ç¾½", nextId: "han_early", effect: { health: 10, wealth: 10, reputation: -5 }, feedback: "ç«ç‡’é˜¿æˆ¿å®®ã€‚", historyNote: "é …ç¾½å¤±æ°‘å¿ƒã€‚" }, { text: "é€ƒå›é„‰é‡Œ", nextId: "han_early", effect: { health: 5, wealth: -5 }, feedback: "ä¿å…¨æ€§å‘½ã€‚", historyNote: "æˆ°äº‚äººå£éŠ³æ¸›ã€‚" }] },
            "han_early": { id: "han_early", title: "8. æ¼¢åˆä¼‘é¤Š", text: "é»ƒè€ä¹‹è¡“ï¼Œç„¡ç‚ºè€Œæ²»ã€‚", image: "Farm", options: [{ text: "æ­¸é„‰è€•ç”°", nextId: "han_wenjing", effect: { health: 10, wealth: 20, reputation: 5 }, feedback: "è¼•å¾­è–„è³¦ã€‚", historyNote: "ä¼‘é¤Šç”Ÿæ¯ã€‚" }, { text: "ç ”è®€é“å®¶", nextId: "han_wenjing", effect: { knowledge: 20, reputation: 5 }, feedback: "æ¸…éœç„¡ç‚ºã€‚", historyNote: "æ¼¢åˆä¸»æµæ€æƒ³ã€‚" }, { text: "å”åŠ©å®˜åºœ", nextId: "han_wenjing", effect: { prestige: 10, wealth: 5 }, feedback: "è•­è¦æ›¹éš¨ã€‚", historyNote: "æ”¿æ²»æ¸…æ˜ã€‚" }] },
            "han_wenjing": { id: "han_wenjing", title: "9. æ–‡æ™¯ä¹‹æ²»", text: "ç™¾å§“å¯Œåº¶ã€‚", image: "Treasury", options: [{ text: "å¤§åŠ›ç¶“å•†", nextId: "han_seven_states", effect: { wealth: 50, knowledge: 5 }, feedback: "æˆç‚ºå¯Œå•†ã€‚", historyNote: "å•†æ¥­ç¹æ¦®ã€‚" }, { text: "èˆˆè¾¦ç§å­¸", nextId: "han_seven_states", effect: { knowledge: 20, reputation: 20, wealth: -10 }, feedback: "æ¡ƒææ»¿å¤©ä¸‹ã€‚", historyNote: "æ–‡åŒ–å¾©ç”¦ã€‚" }, { text: "äº«å—ç››ä¸–", nextId: "han_seven_states", effect: { health: 20, wealth: -20 }, feedback: "å¿«æ¨‚æ™‚å…‰ã€‚", historyNote: "åˆ‘ç½°æ¸›è¼•ã€‚" }] },
            "han_seven_states": { id: "han_seven_states", title: "10. ä¸ƒåœ‹ä¹‹äº‚", text: "ä¸ƒåœ‹é€ åã€‚", image: "War", options: [{ text: "æŠ•è»å¹³å›", nextId: "han_wu_ideology", reqReputation: 20, effect: { reputation: 30, health: -20, wealth: 20 }, feedback: "ç«‹ä¸‹æˆ°åŠŸã€‚", historyNote: "å‘¨äºå¤«å¹³å›ã€‚" }, { text: "æè³‡åŠ©è»", nextId: "han_wu_ideology", effect: { wealth: -30, reputation: 10 }, feedback: "è²¡å¯ŒåŠ©åœ‹ã€‚", historyNote: "æ™éŒ¯è¢«æ®ºã€‚" }, { text: "èº²é¿æˆ°äº‚", nextId: "han_wu_ideology", effect: { health: 5, wealth: -10, reputation: -5 }, feedback: "éŒ¯å¤±è‰¯æ©Ÿã€‚", historyNote: "è«¸ä¾¯å‰Šæ¬Šã€‚" }] },
            "han_wu_ideology": { id: "han_wu_ideology", title: "11. ç¨å°Šå„’è¡“", text: "æ¼¢æ­¦å¸ç½·é»œç™¾å®¶ã€‚", image: "Study", options: [{ text: "æ”»è®€äº”ç¶“", nextId: "han_wu_eco", reqKnowledge: 30, effect: { knowledge: 30, reputation: 10, health: -5 }, feedback: "å¤©å­é–€ç”Ÿã€‚", historyNote: "å¤ªå­¸å»ºç«‹ã€‚" }, { text: "å …æŒé»ƒè€", nextId: "han_wu_eco", effect: { reputation: -10, knowledge: 5 }, feedback: "ä»•é€”å—é˜»ã€‚", historyNote: "æ€æƒ³ä¸åˆæ™‚å®œã€‚" }, { text: "é‘½ç ”æ³•å®¶", nextId: "han_wu_eco", effect: { reputation: 5, knowledge: 10, wealth: 10 }, feedback: "å„’è¡¨æ³•è£¡ã€‚", historyNote: "é‡ç”¨é…·åã€‚" }] },
            "han_wu_eco": { id: "han_wu_eco", title: "12. é¹½éµå®˜ç‡Ÿ", text: "æ¡‘å¼˜ç¾Šæ¨è¡Œå®˜ç‡Ÿã€‚", image: "Treasury", options: [{ text: "æ”¯æŒå®˜ç‡Ÿ", nextId: "han_zhang_qian", effect: { reputation: 10, wealth: 20, knowledge: 10 }, feedback: "åœ‹åº«å……ç›ˆã€‚", historyNote: "å¢åŠ è²¡æ”¿æ”¶å…¥ã€‚" }, { text: "åå°å®˜ç‡Ÿ", nextId: "han_zhang_qian", effect: { reputation: 20, wealth: -10, knowledge: 10 }, feedback: "è´å¾—å°Šé‡ã€‚", historyNote: "é¹½éµæœƒè­°ã€‚" }, { text: "ç§ä¸‹å€’è³£", nextId: "han_zhang_qian", effect: { wealth: 40, health: -10 }, feedback: "å¯Œå¯æ•µåœ‹ã€‚", historyNote: "é¢¨éšªæ¥µå¤§ã€‚" }] },
            "han_zhang_qian": { id: "han_zhang_qian", title: "13. é‘¿ç©ºè¥¿åŸŸ", text: "å¼µé¨«å‡ºä½¿ã€‚", image: "Desert", options: [{ text: "éš¨å¼µé¨«å‡ºä½¿", nextId: "han_war", reqHealth: 50, effect: { health: -30, reputation: 40, wealth: 30, knowledge: 20 }, feedback: "çµ²è·¯é–‹é€šã€‚", historyNote: "ä¸­è¥¿äº¤æµã€‚" }, { text: "ç•™å®ˆç¹ªåœ–", nextId: "han_war", effect: { knowledge: 20, wealth: 10, reputation: 5 }, feedback: "æ•´ç†æƒ…å ±ã€‚", historyNote: "è¥¿åŸŸéƒ½è­·åºœã€‚" }, { text: "æŠ•è³‡è²¿æ˜“", nextId: "han_war", reqWealth: 30, effect: { wealth: 50 }, feedback: "çµ²è·¯å•†äººã€‚", historyNote: "çµ²ç¶¢å¤–éŠ·ã€‚" }] },
            "han_war": { id: "han_war", title: "14. æ¼ åŒ—æ±ºæˆ°", text: "è¡›é’éœå»ç—…åŒ—ä¼ã€‚", image: "War", options: [{ text: "è¿½éš¨éœå»ç—…", nextId: "han_sima", reqHealth: 60, effect: { reputation: 50, health: -40, wealth: 20 }, feedback: "å°ç‹¼å±…èƒ¥ã€‚", historyNote: "åŒˆå¥´é éã€‚" }, { text: "æ“”ä»»å¾Œå‹¤", nextId: "han_sima", effect: { health: -10, wealth: 10, reputation: 5 }, feedback: "ç³§è‰å…ˆè¡Œã€‚", historyNote: "åœ‹åŠ›æ¶ˆè€—ã€‚" }, { text: "ç•æˆ°é€ƒè·‘", nextId: "han_sima", effect: { reputation: -30, health: 5 }, feedback: "æˆç‚ºé€ƒå…µã€‚", historyNote: "æ¼¢å¾‹åš´æ‡²ã€‚" }] },
            "han_sima": { id: "han_sima", title: "15. è˜‡æ­¦ç‰§ç¾Š", text: "è˜‡æ­¦åŒ—æµ·ç‰§ç¾Šã€‚", image: "Desert", options: [{ text: "é€å»é£Ÿç‰©", nextId: "han_zhaojun", reqWealth: 30, effect: { wealth: -20, reputation: 30 }, feedback: "é›ªä¸­é€ç‚­ã€‚", historyNote: "æŒç¯€ä¸å±ˆã€‚" }, { text: "å‹¸èªªå–®äº", nextId: "han_zhaojun", reqKnowledge: 50, effect: { knowledge: 10, reputation: 20 }, feedback: "æ”¹å–„å¾…é‡ã€‚", historyNote: "æ¼¢åŒˆé—œä¿‚ã€‚" }, { text: "æ„Ÿå˜†å¿ ç¾©", nextId: "han_zhaojun", effect: { knowledge: 5 }, feedback: "è¦‹è­‰æ°£ç¯€ã€‚", historyNote: "æé™µç¾æ„§ã€‚" }] },
            "han_zhaojun": { id: "han_zhaojun", title: "16. å²å®¶çµ•å”±", text: "å¸é¦¬é·ä¸‹ç„ã€‚", image: "Prison", options: [{ text: "å‡ºè³‡è´–ç½ª", nextId: "wang_mang", reqWealth: 80, effect: { wealth: -80, reputation: 30, knowledge: 10 }, feedback: "æƒ…ç¾©ç„¡åƒ¹ã€‚", historyNote: "è´–æ­»ç½ªã€‚" }, { text: "é¼“å‹µè‘—æ›¸", nextId: "wang_mang", effect: { knowledge: 30, reputation: 10 }, feedback: "å²è¨˜å®Œæˆã€‚", historyNote: "ç„¡éŸ»é›¢é¨·ã€‚" }, { text: "é¿ä¹‹ä¸åŠ", nextId: "wang_mang", effect: { reputation: -10 }, feedback: "å†·æ¼ ä»¥å°ã€‚", historyNote: "æ˜å“²ä¿èº«ã€‚" }] },
            "wang_mang": { id: "wang_mang", title: "17. æ˜­å›å‡ºå¡", text: "ç‹æ˜­å›å’Œè¦ªã€‚", image: "Desert", options: [{ text: "è­·é€æ˜­å›", nextId: "han_guangwu", reqHealth: 30, effect: { health: -20, reputation: 20, wealth: 20, knowledge: 10 }, feedback: "é‚Šç–†å’Œå¹³ã€‚", historyNote: "æ°‘æ—èåˆã€‚" }, { text: "æ­ç™¼ç•«å¸«", nextId: "han_guangwu", effect: { reputation: 15, wealth: 10 }, feedback: "æ¯›å»¶å£½ä¼æ³•ã€‚", historyNote: "ç•«å¸«ç´¢è³„ã€‚" }, { text: "æ„Ÿå˜†ç´…é¡", nextId: "han_guangwu", effect: { knowledge: 5 }, feedback: "å¯«ä¸‹è©©ç¯‡ã€‚", historyNote: "å¾Œä¸–é¡Œæã€‚" }] },
            "han_guangwu": { id: "han_guangwu", title: "18. ç‹è½æ–°æœ", text: "ç‹è½æ”¹åˆ¶ã€‚", image: "Treasury", options: [{ text: "å›¤ç©é»ƒé‡‘", nextId: "han_ban_chao", reqKnowledge: 40, effect: { knowledge: 20, wealth: 30 }, feedback: "èº²éç ´ç”¢ã€‚", historyNote: "å¹£åˆ¶æ··äº‚ã€‚" }, { text: "åŠ å…¥ç¶ æ—", nextId: "han_ban_chao", effect: { health: -20, reputation: 20, wealth: 10 }, feedback: "æ¨ç¿»æ–°æœã€‚", historyNote: "èµ¤çœ‰èµ·ç¾©ã€‚" }, { text: "ç›¡å¿ ç‹è½", nextId: "han_ban_chao", effect: { wealth: -20, reputation: -20 }, feedback: "éš¨æœè¦†æ»…ã€‚", historyNote: "æ”¹é©å¤±æ•—ã€‚" }] },
            "han_ban_chao": { id: "han_ban_chao", title: "19. å…‰æ­¦ä¸­èˆˆ", text: "åŠ‰ç§€å»ºç«‹æ±æ¼¢ã€‚", image: "QinPalace", options: [{ text: "æŠ•å¥”åŠ‰ç§€", nextId: "east_han_politics", reqReputation: 30, effect: { reputation: 30, wealth: 40, health: -10 }, feedback: "å¤©ä¸‹æ­¸ä¸€ã€‚", historyNote: "æŸ”é“æ²»åœ‹ã€‚" }, { text: "è§£ç”²æ­¸ç”°", nextId: "east_han_politics", effect: { health: 20, wealth: 10 }, feedback: "äº«å—å’Œå¹³ã€‚", historyNote: "ç¶“æ¿Ÿæ¢å¾©ã€‚" }, { text: "å‰²æ“šä¸€æ–¹", nextId: "east_han_politics", effect: { health: -30, reputation: -20 }, feedback: "è¢«æ“Šæ•—æµäº¡ã€‚", historyNote: "æ¶ˆæ»…å‰²æ“šã€‚" }] },
            "east_han_politics": { id: "east_han_politics", title: "20. æŠ•ç­†å¾æˆ", text: "ç­è¶…é€šè¥¿åŸŸã€‚", image: "Desert", options: [{ text: "æ•ˆæ³•ç­è¶…", nextId: "han_tech", effect: { knowledge: 10, reputation: 20, health: -10 }, feedback: "å¨éœ‡è¥¿åŸŸã€‚", historyNote: "ç¶“ç‡Ÿè¥¿åŸŸã€‚" }, { text: "ç¹¼çºŒæ–‡æ›¸", nextId: "han_tech", effect: { knowledge: 5, wealth: 10 }, feedback: "å¹³ç©©ä¸€ç”Ÿã€‚", historyNote: "æ–‡å®˜ç³»çµ±ã€‚" }, { text: "ç¶“å•†è‡´å¯Œ", nextId: "han_tech", effect: { wealth: 20, reputation: 0 }, feedback: "çµ²è·¯å¯Œå•†ã€‚", historyNote: "è²¿æ˜“èˆˆç››ã€‚" }] },
            "han_tech": { id: "han_tech", title: "21. å¤–æˆšå®¦å®˜", text: "æ”¿æ²»é»‘æš—ã€‚", image: "QinPalace", options: [{ text: "ä¾é™„å¤–æˆš", nextId: "han_disaster", effect: { wealth: 30, reputation: -10, health: -10 }, feedback: "æ¬Šå‚¾ä¸€æ™‚ã€‚", historyNote: "å¤–æˆšå°ˆæ¬Šã€‚" }, { text: "çµäº¤æ¸…æµ", nextId: "han_disaster", reqKnowledge: 50, effect: { reputation: 20, knowledge: 10 }, feedback: "ä¿æŒæ°£ç¯€ã€‚", historyNote: "å£«å¤§å¤«æŠ—çˆ­ã€‚" }, { text: "é é›¢æœå ‚", nextId: "han_disaster", effect: { health: 10 }, feedback: "æ˜å“²ä¿èº«ã€‚", historyNote: "éš±å£«å¢å¤šã€‚" }] },
            "han_disaster": { id: "han_disaster", title: "22. ç§‘æŠ€å·”å³°", text: "è”¡å€«èˆ‡å¼µè¡¡ã€‚", image: "Study", options: [{ text: "æŠ•è³‡é€ ç´™", nextId: "yellow_turban", reqWealth: 40, effect: { knowledge: 30, reputation: 20, wealth: -20 }, feedback: "æ–‡æ˜å‚³æ‰¿ã€‚", historyNote: "è”¡ä¾¯ç´™ã€‚" }, { text: "ç ”ç©¶å¤©æ–‡", nextId: "yellow_turban", effect: { knowledge: 40, health: 10 }, feedback: "æ´æ‚‰å®‡å®™ã€‚", historyNote: "æ¸¾å¤©å„€ã€‚" }, { text: "ç ”ç©¶é†«å­¸", nextId: "yellow_turban", effect: { health: 20, reputation: 10 }, feedback: "æ‡¸å£ºæ¿Ÿä¸–ã€‚", historyNote: "å‚·å¯’é›œç—…è«–ã€‚" }] },
            "yellow_turban": { id: "yellow_turban", title: "23. é»¨éŒ®ä¹‹ç¦", text: "è¿«å®³é»¨äººã€‚", image: "Prison", options: [{ text: "ç‡Ÿæ•‘åå£«", nextId: "dong_zhuo", reqHealth: 30, effect: { reputation: 40, health: -30, wealth: -20 }, feedback: "è´å¾—æ•¬é‡ã€‚", historyNote: "å£«å¤§å¤«å—å‰µã€‚" }, { text: "ä¾é™„å®¦å®˜", nextId: "dong_zhuo", effect: { wealth: 50, reputation: -50 }, feedback: "å¤±å»åè²ã€‚", historyNote: "é¸å®˜è…æ•—ã€‚" }, { text: "éš±å±…å±±æ—", nextId: "dong_zhuo", effect: { knowledge: 10, health: 10 }, feedback: "é¿ä¸–ä¸å‡ºã€‚", historyNote: "äº‚ä¸–å¾µå…†ã€‚" }] },
            "dong_zhuo": { id: "dong_zhuo", title: "24. é»ƒå·¾èµ·ç¾©", text: "è’¼å¤©å·²æ­»ã€‚", image: "War", options: [{ text: "çµ„ç¹”ç¾©å…µ", nextId: "final_chaos", reqReputation: 50, effect: { reputation: 30, health: -20, wealth: 10 }, feedback: "æˆç‚ºè±ªå¼·ã€‚", historyNote: "è»é–¥å´›èµ·ã€‚" }, { text: "åŠ å…¥é»ƒå·¾", nextId: "final_chaos", effect: { health: -10, wealth: 20, reputation: -10 }, feedback: "æœ€çµ‚è¢«é®å£“ã€‚", historyNote: "æ±æ¼¢ç“¦è§£ã€‚" }, { text: "æ”œå®¶é€ƒé›£", nextId: "final_chaos", effect: { health: -20, wealth: -20 }, feedback: "æµé›¢å¤±æ‰€ã€‚", historyNote: "äººå£éŠ³æ¸›ã€‚" }] },
            "final_chaos": { id: "final_chaos", title: "25. è‘£å“äº‚æ”¿", text: "ç«ç‡’æ´›é™½ã€‚", image: "Fire", options: [{ text: "è¨ä¼è‘£å“", nextId: "ending_calc", reqHealth: 50, effect: { reputation: 40, health: -30 }, feedback: "å±•ç¾å¿ ç¾©ã€‚", historyNote: "è¯è»è§£æ•£ã€‚" }, { text: "ä¿è­·ç™¾å§“", nextId: "ending_calc", effect: { reputation: 30, wealth: -10 }, feedback: "è¬å®¶ç”Ÿä½›ã€‚", historyNote: "è¥¿é·é•·å®‰ã€‚" }, { text: "å†·çœ¼æ—è§€", nextId: "ending_calc", effect: { wealth: 20 }, feedback: "ä¿å­˜å¯¦åŠ›ã€‚", historyNote: "ä¸‰åœ‹åºå¹•ã€‚" }] },

            // çµå±€è¨ˆç®—
            "ending_calc": { id: "ending_calc", title: "çµç®—ä¸­...", text: "...", isCalc: true, image: "Classroom" },
            "ending_emperor": { id: "ending_emperor", title: "çµå±€ï¼šåƒå¤ä¸€å¸", text: "ä½ æ–‡æ²»æ­¦åŠŸï¼Œå¯Œç”²å¤©ä¸‹ï¼Œæˆç‚ºäº†æ­·å²çš„å‚³å¥‡ã€‚", image: "QinPalace" },
            "ending_general": { id: "ending_general", title: "çµå±€ï¼šäº‚ä¸–åå°‡", text: "ä½ å‹‡å† ä¸‰è»ï¼Œè²åé æ’­ï¼Œæ˜¯æ™‚ä»£çš„å®ˆè­·è€…ã€‚", image: "War" },
            "ending_scholar": { id: "ending_scholar", title: "çµå±€ï¼šä¸€ä»£å®—å¸«", text: "ä½ åšå¤é€šä»Šï¼Œå‚³æ‰¿äº†æ–‡æ˜çš„ç«ç¨®ã€‚", image: "Study" },
            "ending_rich": { id: "ending_rich", title: "çµå±€ï¼šå¯Œç”²ä¸€æ–¹", text: "ä½ æŒæ¡äº†ç¶“æ¿Ÿå‘½è„ˆï¼Œå¯Œå¯æ•µåœ‹ã€‚", image: "Treasury" },
            "ending_official": { id: "ending_official", title: "çµå±€ï¼šæ¬Šå‚¾æœé‡", text: "ä½ é•·è¢–å–„èˆï¼Œæ¬Šè¬€éäººï¼Œæˆç‚ºä¸€ä»£æ¬Šè‡£ã€‚", image: "QinPalace" },
            "ending_doctor": { id: "ending_doctor", title: "çµå±€ï¼šæ‡¸å£ºæ¿Ÿä¸–", text: "ä½ ç²¾é€šé†«è¡“ï¼Œæ•‘æ­»æ‰¶å‚·ï¼Œè¢«å°Šç‚ºé†«è–ã€‚", image: "Study" },
            "ending_exile": { id: "ending_exile", title: "çµå±€ï¼šæµäº¡æµ·å¤–", text: "ä½ å¸¶è‘—è²¡å¯Œé èµ°é«˜é£›ï¼Œåœ¨æµ·å¤–é–‹ææ•£è‘‰ã€‚", image: "Desert" },
            "ending_martyr": { id: "ending_martyr", title: "çµå±€ï¼šèµ·ç¾©çƒˆå£«", text: "ä½ ç‚ºäº†ç†æƒ³è€Œæˆ°ï¼Œé›–ç„¶çŠ§ç‰²ï¼Œä½†ç²¾ç¥æ°¸å­˜ã€‚", image: "Fire" },
            "ending_commoner": { id: "ending_commoner", title: "çµå±€ï¼šæ­¸éš±ç”°åœ’", text: "ä½ å¹³å®‰åº¦éäº‚ä¸–ï¼Œè¦‹è­‰äº†æ­·å²çš„èˆˆè¡°ã€‚", image: "Farm" },
            "game_over": { id: "game_over", title: "å£¯å¿—æœªé…¬", text: "ä½ å€’åœ¨äº†æ­·å²çš„é•·æ²³ä¸­...", image: "Fire" }
        };

        // éš¨æ©Ÿäº‹ä»¶
        const randomEvents = [
            { name: "ææ–¯", role: "ç§¦æœä¸ç›¸", question: "å¾æè­°å»¢åˆ†å°ï¼Œè¡Œéƒ¡ç¸£ã€‚ä½ å¯çŸ¥ç§¦æœå°‡å¤©ä¸‹åˆ†ç‚ºå¤šå°‘éƒ¡ï¼Ÿ", options: ["åäºŒéƒ¡", "ä¸‰åå…­éƒ¡", "å››åå…«éƒ¡", "å…«åä¸€éƒ¡"], answer: 1, correctMsg: "ç„¶ä¹Ÿï¼é›†æ¬Šä¸­å¤®ã€‚", wrongMsg: "è¬¬çŸ£ï¼", reward: { knowledge: 10, prestige: 5 }, penalty: { knowledge: -5 } },
            { npc: "èŠè»»", role: "ç‡•åœ‹åˆºå®¢", question: "é¢¨è•­è•­å…®æ˜“æ°´å¯’... ä¸‹ä¸€å¥ç‚ºä½•ï¼Ÿ", options: ["å£¯å£«ä¸€å»å…®ä¸å¾©é‚„", "å¤§é¢¨èµ·å…®é›²é£›æš", "åŠ›æ‹”å±±å…®æ°£è“‹ä¸–", "æ­¤æ¨ç¶¿ç¶¿ç„¡çµ•æœŸ"], answer: 0, correctMsg: "æ‡‚æˆ‘è€…ï¼Œå£¯å£«ä¹Ÿï¼", wrongMsg: "ä¸æ‡‚é¢¨é›…ã€‚", reward: { health: 10, reputation: 5 }, penalty: { reputation: -5 } },
            { npc: "éŸ“ä¿¡", role: "å¤§å°‡è»", question: "å¾èƒŒæ°´ä¸€æˆ°æ“Šæ•—è¶™è»ã€‚æ­¤æˆ°ç™¼ç”Ÿåœ¨ä½•è™•ï¼Ÿ", options: ["é‰…é¹¿", "äº•é™˜", "å“ä¸‹", "å®˜æ¸¡"], answer: 1, correctMsg: "å…µæ³•ä¹‹é“ï¼Œå­˜ä¹ä¸€å¿ƒã€‚", wrongMsg: "éŒ¯äº†ã€‚", reward: { reputation: 15 }, penalty: { health: -10 } },
            { npc: "å¼µé¨«", role: "åšæœ›ä¾¯", question: "å¾å‡ºä½¿è¥¿åŸŸï¼Œæ˜¯ç‚ºäº†è¯åˆèª°å¤¾æ“ŠåŒˆå¥´ï¼Ÿ", options: ["å¤§å®›", "çƒå­«", "å¤§æœˆæ°", "æ¨“è˜­"], answer: 2, correctMsg: "æ­£æ˜¯ï¼", wrongMsg: "éä¹Ÿã€‚", reward: { knowledge: 10, wealth: 10 }, penalty: { wealth: -5 } },
            { npc: "å¸é¦¬é·", role: "å¤ªå²ä»¤", question: "å¾å¯«ã€Šå²è¨˜ã€‹ï¼Œèª“è¦ã€Œç©¶å¤©äººä¹‹éš›ã€... ä¸‹å¥ï¼Ÿ", options: ["æˆä¸€å®¶ä¹‹è¨€", "é€šå¤ä»Šä¹‹è®Š", "æµèŠ³ç™¾ä¸–", "ä»¥å²ç‚ºé¡"], answer: 1, correctMsg: "çŸ¥æˆ‘è€…è¬‚æˆ‘å¿ƒæ†‚ã€‚", wrongMsg: "å”‰ã€‚", reward: { knowledge: 15 }, penalty: { knowledge: -10 } },
            { npc: "è‘£ä»²èˆ’", role: "å„’å­¸å¤§å¸«", question: "å¾å»ºè­°ã€Œç½·é»œç™¾å®¶ã€ï¼Œç¨å°Šå“ªä¸€å®¶ï¼Ÿ", options: ["é“å®¶", "æ³•å®¶", "å¢¨å®¶", "å„’å®¶"], answer: 3, correctMsg: "å–„å“‰ã€‚", wrongMsg: "æœ½æœ¨ä¸å¯é›•ã€‚", reward: { prestige: 10, knowledge: 5 }, penalty: { prestige: -5 } },
            { npc: "ç‹æ˜­å›", role: "å’Œè¦ªå…¬ä¸»", question: "æˆ‘å«çµ¦äº†å“ªä½å–®äºï¼Ÿ", options: ["å†’é “", "å‘¼éŸ“é‚ª", "ä¼Šç¨šæ–œ", "è»è‡£"], answer: 1, correctMsg: "é¡˜é‚Šç–†å’Œå¹³ã€‚", wrongMsg: "ä»¤äººå¿ƒå¯’ã€‚", reward: { reputation: 15 }, penalty: { reputation: -10 } },
            { npc: "è”¡å€«", role: "ç™¼æ˜å®¶", question: "æˆ‘æ”¹è‰¯é€ ç´™è¡“ï¼Œä¸»è¦ç”¨äº†ä»€éº¼åŸæ–™ï¼Ÿ", options: ["çµ²ç¶¢", "æ¨¹çš®èˆ‡ç ´å¸ƒ", "ç¾Šçš®", "ç«¹ç°¡"], answer: 1, correctMsg: "ç‰©ç›¡å…¶ç”¨ã€‚", wrongMsg: "å¤ªæ˜‚è²´äº†ã€‚", reward: { knowledge: 10, wealth: 5 }, penalty: { wealth: -5 } },
            { npc: "å¼µè§’", role: "å¤ªå¹³é“", question: "è’¼å¤©å·²æ­»ï¼Œé»ƒå¤©ç•¶ç«‹ï¼Œæ­²åœ¨...ï¼Ÿ", options: ["ç”²å­", "ä¹™ä¸‘", "ä¸™å¯…", "ä¸å¯"], answer: 0, correctMsg: "å¤©ä¸‹å¤§å‰ï¼", wrongMsg: "å¤©æ™‚æœªåˆ°ã€‚", reward: { health: 10, wealth: 10 }, penalty: { reputation: -10 } },
            { npc: "é …ç¾½", role: "éœ¸ç‹", question: "å¾èˆ‡åŠ‰é‚¦æ±ºæˆ°æ–¼ä½•è™•ï¼Ÿ", options: ["é´»é–€", "å’¸é™½", "å“ä¸‹", "å½­åŸ"], answer: 2, correctMsg: "åŠ›æ‹”å±±å…®...", wrongMsg: "èƒ¡èªªï¼", reward: { health: 15 }, penalty: { health: -20 } }
        ];

        const SceneDisplay = ({ imageName }) => {
            const [imgError, setImgError] = useState(false);
            const imageUrl = SceneImages[imageName] || SceneImages.Classroom;

            return (
                <div className="w-full h-56 md:h-64 mb-6 relative scene-image-container bg-[#1a1a1a]">
                    {!imgError ? (
                        <img 
                            src={imageUrl} 
                            alt="å ´æ™¯åœ–" 
                            className="w-full h-full object-cover transition-transform duration-500 hover:scale-105"
                            onError={() => setImgError(true)}
                        />
                    ) : (
                        <div className="w-full h-full flex items-center justify-center text-stone-500 bg-stone-900 flex-col">
                            <div className="text-4xl mb-2">ğŸ–¼ï¸</div>
                            <div className="text-xs text-stone-400">è«‹ç¢ºèªåœ–ç‰‡: {imageUrl}</div>
                        </div>
                    )}
                    <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent pointer-events-none"></div>
                </div>
            );
        };

        const QuizModal = ({ quiz, onAnswer }) => {
            return (
                <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 modal-enter">
                    <div className="game-container p-6 max-w-lg w-full text-center relative bg-[#2a2a3a]">
                        <div className="absolute -top-5 left-1/2 transform -translate-x-1/2 bg-purple-700 text-white px-4 py-1 border-2 border-purple-400 shadow-lg font-bold">
                            æ­·å²åäººå ‚
                        </div>
                        <h3 className="text-2xl font-bold text-purple-300 mb-2 mt-4">{quiz.npc} <span className="text-sm text-stone-400">({quiz.role})</span></h3>
                        <p className="text-lg text-stone-200 mb-6 border-b border-stone-600 pb-4">{quiz.question}</p>
                        <div className="grid grid-cols-1 gap-3">
                            {quiz.options.map((opt, idx) => (
                                <div 
                                    key={idx}
                                    onClick={() => onAnswer(idx)}
                                    className="option-block text-center py-3 hover:bg-purple-900 hover:border-purple-400"
                                >
                                    {opt}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [currentSceneId, setCurrentSceneId] = useState('intro');
            const [stats, setStats] = useState({ health: 100, knowledge: 10, wealth: 20, reputation: 0 });
            const [feedback, setFeedback] = useState(null);
            const [floatStats, setFloatStats] = useState([]);
            const [selectedOption, setSelectedOption] = useState(null);
            const [nextSceneId, setNextSceneId] = useState(null);
            const [shake, setShake] = useState(false);
            const [quizEvent, setQuizEvent] = useState(null);
            const [seenEventIndices, setSeenEventIndices] = useState(new Set());
            const [waitingForNext, setWaitingForNext] = useState(false);

            const currentScene = storyNodes[currentSceneId] || storyNodes['intro'];

            const triggerShake = () => { setShake(true); setTimeout(() => setShake(false), 500); };
            const showFeedback = (msg, type) => { setFeedback({ msg, type }); setTimeout(() => setFeedback(null), 3000); };

            // éš¨æ©Ÿäº‹ä»¶èˆ‡çµå±€é‚è¼¯
            useEffect(() => {
                if (currentScene?.isCalc) {
                    let nextId = 'ending_commoner';
                    if (stats.health <= 0) nextId = 'game_over';
                    else {
                        const { health, knowledge, wealth, reputation } = stats;
                        if (reputation >= 100 && wealth >= 80 && knowledge >= 60) nextId = 'ending_emperor';
                        else if (wealth >= 80 && knowledge >= 80 && reputation < 40) nextId = 'ending_official'; 
                        else if (reputation >= 80 && health >= 60) nextId = 'ending_general';
                        else if (knowledge >= 100 && health >= 60) nextId = 'ending_doctor'; 
                        else if (knowledge >= 100) nextId = 'ending_scholar';
                        else if (wealth >= 120 && reputation < 50) nextId = 'ending_exile'; 
                        else if (wealth >= 100) nextId = 'ending_rich';
                        else if (reputation >= 60 && health <= 30) nextId = 'ending_martyr'; 
                        else nextId = 'ending_commoner';
                    }
                    setTimeout(() => setCurrentSceneId(nextId), 2000);
                } else if (!currentSceneId.startsWith('ending') && currentSceneId !== 'intro' && currentSceneId !== 'game_over' && !quizEvent && !waitingForNext) {
                    if (Math.random() < 0.20) {
                        const availableIndices = randomEvents.map((_, i) => i).filter(i => !seenEventIndices.has(i));
                        if (availableIndices.length > 0) {
                            const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
                            setQuizEvent(randomEvents[randomIndex]);
                            setSeenEventIndices(prev => new Set(prev).add(randomIndex));
                        }
                    }
                }
            }, [currentSceneId, waitingForNext]);

            const handleQuizAnswer = (answerIndex) => {
                const isCorrect = answerIndex === quizEvent.answer;
                let newStats = { ...stats };
                let changes = [];

                if (isCorrect) {
                    if (quizEvent.reward.knowledge) { newStats.knowledge += quizEvent.reward.knowledge; changes.push({label:'æ™ºåŠ›', val:quizEvent.reward.knowledge, color:'bg-blue-500'}); }
                    if (quizEvent.reward.prestige) { newStats.reputation += quizEvent.reward.prestige; changes.push({label:'è²æœ›', val:quizEvent.reward.prestige, color:'bg-purple-500'}); }
                    if (quizEvent.reward.health) { newStats.health += quizEvent.reward.health; changes.push({label:'é«”åŠ›', val:quizEvent.reward.health, color:'bg-red-500'}); }
                    if (quizEvent.reward.wealth) { newStats.wealth += quizEvent.reward.wealth; changes.push({label:'è²¡å¯Œ', val:quizEvent.reward.wealth, color:'bg-yellow-500'}); }
                    if (quizEvent.reward.reputation) { newStats.reputation += quizEvent.reward.reputation; changes.push({label:'è²æœ›', val:quizEvent.reward.reputation, color:'bg-purple-500'}); }
                    playSound('confirm');
                    showFeedback(`[âœ” æ­£ç¢º] ${quizEvent.correctMsg}`, 'story');
                } else {
                    if (quizEvent.penalty.knowledge) { newStats.knowledge += quizEvent.penalty.knowledge; changes.push({label:'æ™ºåŠ›', val:quizEvent.penalty.knowledge, color:'bg-gray-500'}); }
                    if (quizEvent.penalty.prestige) { newStats.reputation += quizEvent.penalty.prestige; changes.push({label:'è²æœ›', val:quizEvent.penalty.prestige, color:'bg-gray-500'}); }
                    if (quizEvent.penalty.health) { newStats.health += quizEvent.penalty.health; changes.push({label:'é«”åŠ›', val:quizEvent.penalty.health, color:'bg-gray-500'}); }
                    if (quizEvent.penalty.wealth) { newStats.wealth += quizEvent.penalty.wealth; changes.push({label:'è²¡å¯Œ', val:quizEvent.penalty.wealth, color:'bg-gray-500'}); }
                    if (quizEvent.penalty.reputation) { newStats.reputation += quizEvent.penalty.reputation; changes.push({label:'è²æœ›', val:quizEvent.penalty.reputation, color:'bg-gray-500'}); }
                    playSound('error');
                    triggerShake();
                    showFeedback(`[âŒ éŒ¯èª¤] ${quizEvent.wrongMsg}`, 'error');
                }
                setStats(newStats);
                setFloatStats(changes);
                setQuizEvent(null);
            };

            const handleChoice = (option, index) => {
                if (option.reqKnowledge && stats.knowledge < option.reqKnowledge) { playSound('error'); triggerShake(); showFeedback(`[âŒ æ™ºåŠ›ä¸è¶³] éœ€ ${option.reqKnowledge}`, 'error'); return; }
                if (option.reqHealth && stats.health < option.reqHealth) { playSound('error'); triggerShake(); showFeedback(`[âŒ é«”åŠ›ä¸è¶³] éœ€ ${option.reqHealth}`, 'error'); return; }
                if (option.reqWealth && stats.wealth < option.reqWealth) { playSound('error'); triggerShake(); showFeedback(`[âŒ è²¡å¯Œä¸è¶³] éœ€ ${option.reqWealth}`, 'error'); return; }
                if (option.reqReputation && stats.reputation < option.reqReputation) { playSound('error'); triggerShake(); showFeedback(`[âŒ è²æœ›ä¸è¶³] éœ€ ${option.reqReputation}`, 'error'); return; }

                playSound('select');
                setSelectedOption(index);
                setWaitingForNext(true);

                let newStats = { ...stats };
                let changes = [];
                const effect = option.effect || {};
                
                if (effect.health) { newStats.health += effect.health; changes.push({label:'é«”åŠ›', val:effect.health, color: effect.health>0?'text-green-400':'text-red-400'}); }
                if (effect.knowledge) { newStats.knowledge += effect.knowledge; changes.push({label:'æ™ºåŠ›', val:effect.knowledge, color: 'text-blue-400'}); }
                if (effect.wealth) { newStats.wealth += effect.wealth; changes.push({label:'è²¡å¯Œ', val:effect.wealth, color: 'text-yellow-400'}); }
                if (effect.reputation) { newStats.reputation += effect.reputation; changes.push({label:'è²æœ›', val:effect.reputation, color: 'text-purple-400'}); }

                if (newStats.health < 0) newStats.health = 0;
                setStats(newStats);
                setFloatStats(changes);
                if (option.feedback) showFeedback(`[âœ”] ${option.feedback}`, 'story');
                
                if (newStats.health <= 0) setNextSceneId('game_over');
                else setNextSceneId(option.nextId);
            };

            const handleNext = () => {
                playSound('confirm');
                setCurrentSceneId(nextSceneId);
                setSelectedOption(null);
                setWaitingForNext(false);
                setNextSceneId(null);
                setFloatStats([]);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const resetGame = () => {
                playSound('confirm');
                setCurrentSceneId('intro');
                setStats({ health: 100, knowledge: 10, wealth: 20, reputation: 0 });
                setSelectedOption(null);
                setWaitingForNext(false);
                setFloatStats([]);
                setQuizEvent(null);
                setSeenEventIndices(new Set());
            };

            const isEnding = currentScene.id.startsWith('ending') || currentScene.id === 'game_over';

            return (
                <div className="min-h-screen flex items-center justify-center py-6 px-4">
                    <div className={`max-w-2xl w-full scroll-container rounded-lg relative ${shake ? 'shake' : ''} game-container`}>
                        
                        {/* HUD (Visualized Progress Bars) */}
                        <div className="bg-[#222] text-amber-100 p-4 border-b-4 border-[#5C5B7F] sticky top-0 z-30 shadow-lg">
                            <div className="flex justify-between items-center mb-3">
                                <h1 className="text-3xl font-bold tracking-widest text-yellow-300">ç§¦æ¼¢é¢¨é›²</h1>
                                <div className="text-sm text-stone-300 font-mono">é—œå¡ {currentScene.title.split('.')[0]}</div>
                            </div>
                            <div className="grid grid-cols-2 gap-x-4 gap-y-1">
                                <StatBar label="é«”åŠ›" value={stats.health} max={150} color="bg-red-600" icon={<Icons.Heart/>} />
                                <StatBar label="æ™ºåŠ›" value={stats.knowledge} max={150} color="bg-blue-600" icon={<Icons.Brain/>} />
                                <StatBar label="è²¡å¯Œ" value={stats.wealth} max={150} color="bg-yellow-500" icon={<Icons.Coin/>} />
                                <StatBar label="è²æœ›" value={stats.reputation} max={150} color="bg-purple-600" icon={<Icons.Star/>} />
                            </div>
                        </div>

                        {/* ä¸»è¦å…§å®¹å€ */}
                        <div className="p-6 relative min-h-[500px]">
                            
                            {/* å•ç­”å½ˆçª— */}
                            {quizEvent && <QuizModal quiz={quizEvent} onAnswer={handleQuizAnswer} />}

                            {/* æµ®å‹•æ•¸å€¼ */}
                            <div className="absolute top-4 right-4 z-40 flex flex-col items-end pointer-events-none">
                                {floatStats.map((item, idx) => (
                                    <div key={idx} className={`stat-float ${item.color}`} style={{animationDelay: `${idx * 0.1}s`}}>
                                        {item.label} {item.val > 0 ? '+' : ''}{item.val}
                                    </div>
                                ))}
                            </div>
                            
                            {/* Feedback */}
                            {feedback && (
                                <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 px-6 py-4 bg-stone-900 text-yellow-300 border-4 border-yellow-500 shadow-xl text-center font-bold rounded-none animate-in fade-in zoom-in duration-300">
                                    {feedback.msg}
                                </div>
                            )}

                            {/* æ¨™é¡Œ */}
                            <h2 className="text-3xl font-bold text-center mb-6 text-amber-200 border-b-4 border-stone-600 pb-3">{currentScene.title}</h2>
                            
                            {/* å ´æ™¯åœ– */}
                            {!currentScene.isCalc && <SceneDisplay imageName={currentScene.image} />}

                            {/* æ•…äº‹æ–‡æœ¬ (æ‰“å­—æ©Ÿæ•ˆæœ) */}
                            <div className="text-lg text-stone-200 leading-relaxed mb-8 p-4 bg-[#3b3a5d] border-2 border-stone-600 rounded-none shadow-inner min-h-[100px]">
                                <TypewriterText text={currentScene.text} />
                            </div>

                            <div className="grid gap-4">
                                {!isEnding ? (
                                    currentScene.options.map((opt, idx) => (
                                        <div 
                                            key={idx}
                                            onClick={() => !nextSceneId && handleChoice(opt, idx)}
                                            className={`option-block ${
                                                selectedOption === idx 
                                                    ? 'selected' 
                                                    : nextSceneId !== null 
                                                        ? 'disabled' 
                                                        : ''
                                            } ${nextSceneId && selectedOption !== idx ? 'pointer-events-none opacity-50' : ''}`}
                                        >
                                            <div className="flex justify-between items-center font-bold text-lg mb-1">
                                                <span>{opt.text}</span>
                                                {selectedOption === idx && <span className="text-yellow-800 text-sm animate-pulse">â—„ å·²é¸</span>}
                                            </div>
                                            
                                            {!nextSceneId && (
                                                <div className="text-xs flex flex-wrap gap-x-4 mt-2 font-mono opacity-80">
                                                    {opt.reqKnowledge && <span className="bg-blue-900 px-1 text-white">æ™º {opt.reqKnowledge}</span>}
                                                    {opt.reqHealth && <span className="bg-red-900 px-1 text-white">é«” {opt.reqHealth}</span>}
                                                    {opt.reqWealth && <span className="bg-yellow-900 px-1 text-white">è²¡ {opt.reqWealth}</span>}
                                                    {opt.reqReputation && <span className="bg-purple-900 px-1 text-white">è² {opt.reqReputation}</span>}
                                                </div>
                                            )}

                                            {selectedOption === idx && nextSceneId !== null && (
                                                <div className="mt-4 pt-4 border-t-2 border-stone-500/50 animate-in fade-in slide-in-from-top-2 duration-300 text-black">
                                                    <div className="flex flex-wrap gap-4 font-bold mb-4 text-sm bg-black/20 p-2 rounded">
                                                        {opt.effect?.health !== 0 && <span className={opt.effect.health>0?'text-green-700':'text-red-700'}>é«”åŠ›{opt.effect.health>0?'+':''}{opt.effect.health}</span>}
                                                        {opt.effect?.wealth !== 0 && <span className="text-yellow-700">è²¡å¯Œ{opt.effect.wealth>0?'+':''}{opt.effect.wealth}</span>}
                                                        {opt.effect?.reputation !== 0 && <span className="text-purple-700">è²æœ›{opt.effect.reputation>0?'+':''}{opt.effect.reputation}</span>}
                                                        {opt.effect?.knowledge !== 0 && <span className="text-blue-700">æ™ºåŠ›{opt.effect.knowledge>0?'+':''}{opt.effect.knowledge}</span>}
                                                        {(!opt.effect || Object.values(opt.effect).every(v => v === 0)) && <span className="text-gray-500">æ•¸å€¼ç„¡è®ŠåŒ–</span>}
                                                    </div>
                                                    
                                                    {opt.historyNote && (
                                                        <div className="bg-[#fdf6e3] p-3 rounded-none text-sm text-stone-800 border-2 border-[#d4a017] mb-4 shadow-inner">
                                                            <strong className="block text-[#8b4513] mb-1 border-b border-[#d4a017] pb-1">ğŸ“œ æ­·å²å°è¬›å ‚</strong>
                                                            {opt.historyNote}
                                                        </div>
                                                    )}
                                                    
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); handleNext(); }}
                                                        className="w-full next-btn py-3 font-bold rounded flex items-center justify-center gap-2 shadow-xl transition-transform active:scale-95"
                                                    >
                                                        å‰å¾€ä¸‹ä¸€é—œ <Icons.ArrowRight/>
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-center p-8 bg-[#2a2a2a] border-4 border-stone-600 shadow-xl">
                                        <h3 className="text-3xl text-yellow-300 font-bold mb-4 border-b border-stone-500 pb-4">â€” æ­·å²çš„çµ‚ç«  â€”</h3>
                                        <div className="text-xl text-stone-200 mb-8 leading-relaxed">{currentScene.text}</div>
                                        <button onClick={resetGame} className="pixel-btn w-full py-4 font-bold text-xl text-yellow-300 border-yellow-600">
                                            <Icons.Refresh/> é‡å•Ÿæ™‚å…‰ä¹‹æ—…
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        <div className="bg-[#1A192A] text-[#5C5B7F] text-center py-2 text-xs font-mono border-t-4 border-[#5C5B7F]">
                            æ™‚å…‰è¡Œè€… RPG - ç§¦æ¼¢é¢¨é›² (2024)
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
